name: Polygon Data (optional) + Weekly RSI Backtest (with stops)

on:
  workflow_dispatch:
    inputs:
      update_data:
        description: "Update Polygon data before backtest?"
        type: boolean
        default: false
      years_back:
        description: "Rolling window in years"
        default: "4"
      rsi_min:
        description: "RSI threshold"
        default: "68"
      max_ext20:
        description: "Max |Close/SMA20 - 1|"
        default: "0.15"
      trend_sma:
        description: "Trend filter SMA(N), 0 disables"
        default: "100"
      top_per_week:
        description: "Names per week"
        default: "6"
      use_stops:
        description: "Use in-week hard+trailing stops?"
        type: boolean
        default: true
      abs_stop_pct:
        description: "Hard stop fraction (e.g., 0.02 = 2%)"
        default: "0.02"
      trail_pct:
        description: "Trailing stop fraction (e.g., 0.02 = 2%)"
        default: "0.02"
      slippage_bps:
        description: "Entry/exit slippage (bps)"
        default: "5"

jobs:
  data:
    if: ${{ inputs.update_data }}
    name: Update Polygon data (incremental)
    runs-on: ubuntu-latest
    env:
      DATA_DIR: stock_data_500

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: pip install --upgrade pip && pip install requests pandas

      - name: Compute window
        run: |
          echo "START_DATE=$(date -u -d '${{ inputs.years_back }} years ago' +%F)" >> $GITHUB_ENV
          echo "END_DATE=$(date -u +%F)" >> $GITHUB_ENV

      - name: Restore data cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.DATA_DIR }}
          key: polygon-data-v1
          restore-keys: |
            polygon-data-v1

      - name: Verify scripts present
        run: |
          test -f tools/make_universe_polygon.py || { echo "Missing tools/make_universe_polygon.py"; exit 1; }

      - name: Build 500 by turnover (incremental)
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: |
          python tools/make_universe_polygon.py \
            --out-dir "${DATA_DIR}" \
            --start "${START_DATE}" \
            --end   "${END_DATE}" \
            --universe-size 500

      - name: Save data cache
        uses: actions/cache/save@v4
        with:
          path: ${{ env.DATA_DIR }}
          key: polygon-data-v1

      - name: Upload data artifact
        uses: actions/upload-artifact@v4
        with:
          name: stock_data_500
          path: ${{ env.DATA_DIR }}/**

  backtest:
    name: Weekly RSI Backtest (stops)
    runs-on: ubuntu-latest
    needs: [data]
    if: ${{ always() }}
    env:
      DATA_DIR: stock_data_500
      OUT_DIR: backtests
      WEEKLY_UP_ONLY: "true"     # fixed default; flip to false if you want to disable

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: pip install --upgrade pip && pip install pandas numpy

      - name: Download data artifact (when updated)
        if: ${{ needs.data.result == 'success' }}
        uses: actions/download-artifact@v4
        with:
          name: stock_data_500
          path: ${{ env.DATA_DIR }}

      - name: Restore data cache (when not updated)
        if: ${{ needs.data.result != 'success' }}
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.DATA_DIR }}
          key: polygon-data-v1
          restore-keys: |
            polygon-data-v1

      - name: Verify backtester present
        run: |
          test -f tools/backtest_weekly_rsi_stops.py || { echo "Missing tools/backtest_weekly_rsi_stops.py"; exit 1; }

      - name: Compute window
        run: |
          echo "START_DATE=$(date -u -d '${{ inputs.years_back }} years ago' +%F)" >> $GITHUB_ENV
          echo "END_DATE=$(date -u +%F)" >> $GITHUB_ENV

      - name: Run backtest (with stops)
        run: |
          python tools/backtest_weekly_rsi_stops.py \
            --data-dir "${DATA_DIR}" \
            --start "${START_DATE}" \
            --end   "${END_DATE}" \
            --rsi-min "${{ inputs.rsi_min }}" \
            --max-ext20 "${{ inputs.max_ext20 }}" \
            --trend-sma "${{ inputs.trend_sma }}" \
            $([ "${WEEKLY_UP_ONLY}" = "true" ] && echo --weekly-up-only) \
            --top-per-week "${{ inputs.top_per_week }}" \
            $([ "${{ inputs.use_stops }}" = "true" ] && echo --use-stops) \
            --abs-stop-pct "${{ inputs.abs_stop_pct }}" \
            --trail-pct "${{ inputs.trail_pct }}" \
            --slippage-bps "${{ inputs.slippage_bps }}" \
            --out-dir "${OUT_DIR}"

      - name: Upload backtest artifact
        uses: actions/upload-artifact@v4
        with:
          name: backtests
          path: ${{ env.OUT_DIR }}/**
