name: IW Bot â€” Friday Flatten (MOC)

on:
  schedule:
    # ~10 minutes before close (UTC times; adjust if you want 50 instead of 45)
    - cron: "45 19 * * 5"   # close in EDT (NYC summer)
    - cron: "45 20 * * 5"   # close in EST (NYC winter)
  workflow_dispatch:
    inputs:
      force:
        description: "Force MOC even if not Friday (for testing)"
        required: false
        type: boolean
        default: false

concurrency:
  group: iwbot-flatten
  cancel-in-progress: true

jobs:
  flat:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: python -m pip install --upgrade pip requests

      # --- Inspect current open positions (clean, no inline heredoc) ---
      - name: Show Alpaca positions (paper)
        run: python tools/open_positions.py
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper

      # --- Place MOC orders on Friday. When launched manually with force=true, run anyway. ---
      - name: Flatten with MOC (scheduled run)
        if: ${{ github.event_name == 'schedule' }}
        run: python tools/moc_flatten.py
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper

      - name: Flatten with MOC (manual force)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.force == true }}
        run: python tools/moc_flatten.py --force
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper

      # --- (Optional) show positions again after MOC so you see the effect in logs ---
      - name: Show positions after MOC (paper)
        if: always()
        run: python tools/open_positions.py
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper
