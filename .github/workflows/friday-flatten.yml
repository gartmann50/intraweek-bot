name: IW Bot — Friday Flatten (MOC) — Momentum Only

on:
  schedule:
    - cron: "45 19 * * 5"   # close in EDT (NYC summer)
    - cron: "45 20 * * 5"   # close in EST (NYC winter)
  workflow_dispatch:
    inputs:
      force:
        description: "Flatten immediately (DAY) instead of MOC"
        required: false
        type: boolean
        default: false

concurrency:
  group: iwbot-flatten
  cancel-in-progress: true

jobs:
  flat:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests

      - name: Compute last Friday (NY)
        id: when
        shell: python
        run: |
          from datetime import datetime, timedelta
          from zoneinfo import ZoneInfo
          import os
          ny = ZoneInfo("America/New_York")
          d = datetime.now(ny).date()
          while d.weekday() != 4:
              d -= timedelta(days=1)
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"friday={d}\n")
          print("Anchor Friday:", d)

      - name: Download weekly lots artifact (latest)
        uses: dawidd6/action-download-artifact@v2
        with:
          repo: ${{ github.repository }}
          workflow: market-open.yml
          branch: main
          workflow_conclusion: success
          name: iw-lots-latest
          path: backtests
          if_no_artifact_found: fail



      - name: Sanity — show downloaded lots
        run: |
          ls -Rlh backtests || true
          echo "=== momentum_lots.csv ==="
          sed -n '1,40p' backtests/momentum_lots.csv || true

      - name: Show Alpaca positions BEFORE
        run: python tools/open_positions.py
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    live

      - name: Flatten MOMENTUM qty only (MOC on schedule; DAY if forced)
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    live
          FORCE:         ${{ inputs.force }}
          WEEK_FRIDAY:   ${{ steps.when.outputs.friday }}
          LOTS_CSV:      backtests/momentum_lots.csv
        run: python tools/flatten_momentum_lots.py

      - name: Show Alpaca positions AFTER
        if: always()
        run: python tools/open_positions.py
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    live
