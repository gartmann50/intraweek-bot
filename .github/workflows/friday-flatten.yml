name: IW Bot â€” Friday Flatten (MOC)

on:
  schedule:
    # ~10 minutes before close (UTC times; adjust if you want 50 instead of 45)
    - cron: "45 19 * * 5"   # close in EDT (NYC summer)
    - cron: "45 20 * * 5"   # close in EST (NYC winter)
  workflow_dispatch:
    inputs:
      force:
        description: "Flatten immediately (market DAY) instead of MOC)"
        required: true
        type: boolean
        default: false

concurrency:
  group: iwbot-flatten
  cancel-in-progress: true

jobs:
  flat:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: python -m pip install --upgrade pip requests

      # --- Inspect current open positions (clean, no inline heredoc) ---
      - name: Show Alpaca positions (paper)
        run: python tools/open_positions.py
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper

      # --- Place MOC orders on Friday. When launched manually with force=true, run anyway. ---
      - name: Flatten with MOC (scheduled run)
        if: ${{ github.event_name == 'schedule' }}
        run: python tools/moc_flatten.py
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper

      - name: Cancel all open orders (safety before flatten)
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper
        shell: python
        run: |
          import os, time, requests
          base = "https://paper-api.alpaca.markets" if os.getenv("ALPACA_ENV","paper").startswith("paper") else "https://api.alpaca.markets"
          H = {"APCA-API-KEY-ID": os.environ["ALPACA_KEY"], "APCA-API-SECRET-KEY": os.environ["ALPACA_SECRET"]}
      
          # Cancel all open orders
          r = requests.delete(f"{base}/v2/orders", headers=H, timeout=20)
          print("cancel open orders status:", r.status_code)
      
          # Wait until the cancels settle (keeps flatten from racing)
          for _ in range(10):
              q = requests.get(f"{base}/v2/orders", params={"status":"open","limit":1}, headers=H, timeout=20).json()
              if not q:
                  print("no open orders remaining."); break
              time.sleep(1.0)


      - name: Flatten positions (MOC on schedule; DAY if forced)
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper
          FORCE:         ${{ inputs.force }}   # true when you tick the checkbox
        run: python tools/flatten_positions.py


      # --- (Optional) show positions again after MOC so you see the effect in logs ---
      - name: Show positions after MOC (paper)
        if: always()
        run: python tools/open_positions.py
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper
