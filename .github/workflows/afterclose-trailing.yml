name: IW Bot — After-Close Trailing

on:
  schedule:
    - cron: "25 21 * * 1-5"   # EST
    - cron: "25 20 * * 1-5"   # EDT
  workflow_dispatch: {}

concurrency:
  group: iwbot-trailing
  cancel-in-progress: false

jobs:
  trail:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read      # <-- REQUIRED to download artifacts from friday-build
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: |
          python -m pip install --upgrade pip
          pip install pandas numpy requests
    
      - name: NY date (for daily lock)
        id: nydate
        shell: python
        run: |
          from datetime import datetime
          from zoneinfo import ZoneInfo
          import os
          ny = ZoneInfo("America/New_York")
          d  = datetime.now(ny).date()
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"today_ny={d}\n")
      
      - name: Daily once guard
        id: dlock
        uses: actions/cache@v4
        with:
          path: .trail-flag
          key: trail-${{ steps.nydate.outputs.today_ny }}
      
      - name: Exit if already trailed today
        if: steps.dlock.outputs.cache-hit == 'true'
        run: echo "Already ran trailing for ${{ steps.nydate.outputs.today_ny }} — exiting." && exit 0
      
            # Compute last Friday (if you don't already)
      - name: Compute last Friday
        id: when
        shell: python
        run: |
          from datetime import datetime, timedelta
          import zoneinfo, os
          tz = zoneinfo.ZoneInfo("Europe/Oslo")
          d  = datetime.now(tz).date()
          while d.weekday() != 4:   # 0=Mon..4=Fri
              d -= timedelta(days=1)
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"friday={d}\n")

      - name: Gate to after U.S. close (NY)
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper
        shell: python
        run: |
          import os, time, requests, datetime as dt
          from zoneinfo import ZoneInfo

          ny = ZoneInfo("America/New_York")
          base = "https://paper-api.alpaca.markets" if os.getenv("ALPACA_ENV","paper").startswith("paper") else "https://api.alpaca.markets"
          H = {"APCA-API-KEY-ID": os.environ["ALPACA_KEY"], "APCA-API-SECRET-KEY": os.environ["ALPACA_SECRET"]}

          now = dt.datetime.now(ny)
          today = now.date().isoformat()

          cal = requests.get(f"{base}/v2/calendar", params={"start": today, "end": today}, headers=H, timeout=20).json()
          if not cal:
              print("No calendar for today; skipping gate.")
              raise SystemExit(0)

          close_str = f"{cal[0]['date']} {cal[0]['close']}"  # e.g. '2025-10-07 16:00'
          close_at = dt.datetime.strptime(close_str, "%Y-%m-%d %H:%M").replace(tzinfo=ny)

          target = close_at + dt.timedelta(seconds=60)
          wait = (target - now).total_seconds()
          if 0 < wait <= 7200:
              print(f"Waiting {int(wait)}s until after close…")
              time.sleep(int(wait))
          else:
              print("Already past close; continuing.")

      # Download the picklist artifact produced by friday-build.yml
      - name: Download latest weekly picks
        id: dl_picks
        uses: dawidd6/action-download-artifact@v2
        with:
          repo: ${{ github.repository }}
          workflow: friday-build.yml
          branch: main
          workflow_conclusion: success
          name: ^weekly-picks-${{ steps.when.outputs.friday }}$
          name_is_regexp: true
          path: backtests
          if_no_artifact_found: fail


      - name: Normalize picklist path (copy to backtests/)
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar nullglob
          dest="backtests/picklist_highrsi_trend.csv"
          found=""
          # try exact name first
          for f in backtests/**/picklist_highrsi_trend.csv backtests/picklist_highrsi_trend.csv; do
            if [[ -f "$f" ]]; then
              cp -f "$f" "$dest"
              found="1"
              break
            fi
          done
          # otherwise, fall back to any picklist_*.csv in the artifact
          if [[ -z "$found" ]]; then
            for f in backtests/**/picklist_*.csv; do
              cp -f "$f" "$dest"
              found="1"
              break
            done
          fi
          if [[ -z "$found" ]]; then
            echo "Picklist CSV not found in artifact. Available files:" >&2
            find backtests -maxdepth 3 -type f -printf '%P\n' >&2 || true
            exit 78
          fi
          echo "Using picklist: $dest"
          ls -lh "$dest"


      - name: Sanity check picklist
        run: |
           echo "pwd=$(pwd)"
           ls -lah backtests || true
           test -s backtests/picklist_highrsi_trend.csv || { echo "No picklist file found; aborting trailing."; exit 78; }

      # --- Seed or tighten stops for all open positions (ATR14 × 1.75) ---
      - name: Ensure stops now (seed or tighten) — ATR14 × 1.75, GTC
        env:
          ALPACA_KEY:      ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET:   ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:      paper
          ALPACA_DATA_FEED: iex           # <- add this (iex on paper; sip on live if you have it)
          DATA_DIR:        stock_data_400  # where your local CSVs live
          ATR_WIN:         "14"
          ATR_MULT:        "1.75"
        run: python tools/ensure_stops.py


     
      - uses: actions/upload-artifact@v4
        with:
          name: trailing-stops-${{ steps.when.outputs.friday }}
          path: |
            backtests/positions.json
            backtests/stops.csv
            backtests/exit_symbols.txt
            backtests/trailing_report.txt

      - name: Show open stop orders (Alpaca)
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper
        shell: python
        run: |
          import os, requests
          base = "https://paper-api.alpaca.markets" if os.getenv("ALPACA_ENV","paper").startswith("paper") else "https://api.alpaca.markets"
          H={"APCA-API-KEY-ID":os.environ["ALPACA_KEY"],"APCA-API-SECRET-KEY":os.environ["ALPACA_SECRET"]}
          r = requests.get(f"{base}/v2/orders", params={"status":"open","limit":200}, headers=H, timeout=20)
          r.raise_for_status()
          orders = r.json() or []
          found = False
          for od in orders:
            if od.get("type") in ("stop","stop_limit"):
              found = True
              print(f"{od.get('symbol')}: {od.get('type')} stop_price={od.get('stop_price')} tif={od.get('time_in_force')} id={od.get('id')}")
          if not found:
            print("No open stop orders.")

