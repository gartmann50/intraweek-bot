name: IW Bot — 70D Highs Scan

on:
  schedule:
    - cron: "15 21 * * 5"   # ~after close Fri (EDT)
    - cron: "15 20 * * 5"   # ~after close Fri (EST)
  workflow_dispatch:
    inputs:
      anchor_friday:
        description: "Override anchor Friday (YYYY-MM-DD)"
        required: false
        default: ""
      use_current_week:
        description: "Scan current Mon..today (true/false)"
        required: false
        default: "false"
      top:
        description: "How many names to keep"
        required: false
        default: "10"
      topvol:
        description: "Keep top-N by dollar volume before scanning"
        required: false
        default: "1000"
      cap_min:
        description: "Min market cap USD (0=disable)"
        required: false
        default: "1000000000"
      min_price:
        description: "Min last close"
        required: false
        default: "5"
      min_dollar_vol:
        description: "Min dollar volume (close*volume)"
        required: false
        default: "10000000"

permissions:
  contents: read

concurrency:
  group: iwbot-hi70-scan
  cancel-in-progress: true

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml

      - name: Compute last Friday (NY)
        id: when
        shell: python
        run: |
          from datetime import datetime, timedelta
          from zoneinfo import ZoneInfo
          ny = ZoneInfo("America/New_York")
          d = datetime.now(ny).date()
          while d.weekday() != 4:
              d -= timedelta(days=1)
          open("${{ github.output }}","w").write(f"friday={d}\n")

      # build the same universe
      - name: Build dynamic universe (Top-N by ADV$)
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: |
          python tools/make_universe_topvol.py --adv-days 21 --topvol 1000 --min-price 5 --out-dir backtests
      
      # pass allow-file when scanning
      - name: Scan 70D highs (shared universe)
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: |
          python tools/scan_70d_highs.py \
            --since-days 130 \
            --top 10 \
            --out-dir backtests \
            --allow-file backtests/universe_topvol.txt


      # 1) Scan the market (keep your usual thresholds)
      - name: Scan 70D highs (full market → top by $ volume)
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: |
          python tools/scan_70d_highs.py \
            --since-days 130 \
            --pages 5 \
            --top 10 \
            --out-dir backtests \
            --cap-min 1000000000 \
            --min-price 5 \
            --min-dollar-vol 10000000
      
      # 2) Filter the results to your shared universe
      - name: Filter hi70 to shared universe
        run: |
          python tools/filter_picklist_by_symbols.py \
            backtests/universe_topvol.txt \
            backtests/hi70_thisweek.csv \
            backtests/hi70_thisweek.csv


      - name: Probe hi70 outputs
        run: |
          set -e
          echo "[probe] listing backtests:"; ls -l backtests || true
          CSV=backtests/hi70_thisweek.csv
          if [ -f "$CSV" ]; then
            echo "[probe] head of CSV:"; sed -n '1,12p' "$CSV"
            echo "[probe] row count (excl header):"
            awk -F, 'NR>1 && $1!="" {c++} END{print c+0}' "$CSV"
          fi
          TXT=backtests/hi70_digest.txt
          [ -f "$TXT" ] && { echo "[probe] head of digest:"; sed -n '1,12p' "$TXT"; } || true

      - name: Ensure files exist (create empty CSV header if missing)
        run: |
          set -e
          mkdir -p backtests
          [ -f backtests/hi70_thisweek.csv ] || echo "symbol,name,market_cap,prior70h,week_high,week_close,gap_high_pct,gap_close_pct,first_break_day,bars" > backtests/hi70_thisweek.csv
          [ -f backtests/hi70_digest.txt ]   || echo "hi70 scan digest not produced this run." > backtests/hi70_digest.txt
          echo "[ls]"; ls -l backtests

      - name: Upload 70D-highs artifact
        uses: actions/upload-artifact@v4
        with:
          name: hi70-${{ steps.when.outputs.friday }}
          path: |
            backtests/hi70_thisweek.csv
            backtests/hi70_digest.txt
          if-no-files-found: warn
          retention-days: 7
