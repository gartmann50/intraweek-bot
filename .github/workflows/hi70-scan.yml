name: IW Bot — 70D Highs Scan

on:
  schedule:
    - cron: "15 21 * * 5"   # ~after close Fri (EDT)
    - cron: "15 20 * * 5"   # ~after close Fri (EST)
  workflow_dispatch:
    inputs:
      # Optional overrides for manual runs
      anchor_friday:
        description: "Override anchor Friday (YYYY-MM-DD)"
        required: false
        default: ""
      use_current_week:
        description: "Scan current Mon..today (true/false)"
        required: false
        default: "false"
      # Scanner knobs
      top:
        description: "How many names to write to CSV"
        required: false
        default: "10"
      topvol:
        description: "Keep top-N by dollar volume before scanning"
        required: false
        default: "1000"
      cap_min:
        description: "Min market cap USD (0=disable)"
        required: false
        default: "1000000000"
      min_price:
        description: "Min last close"
        required: false
        default: "5"
      min_dollar_vol:
        description: "Min dollar volume (close*volume)"
        required: false
        default: "10000000"

permissions:
  contents: read

concurrency:
  group: iwbot-hi70-scan
  cancel-in-progress: true

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml

      - name: Compute last Friday (NY)
        id: when
        shell: python
        run: |
          from datetime import datetime, timedelta
          from zoneinfo import ZoneInfo
          ny = ZoneInfo("America/New_York")
          d = datetime.now(ny).date()
          while d.weekday() != 4:  # Friday
              d -= timedelta(days=1)
          open("${{ github.output }}","w").write(f"friday={d}\n")

      - name: Scan 70D highs (full market → top by $ volume)
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          EXTRA=""
          # optional overrides only when provided
          if [ -n "${{ inputs.anchor_friday }}" ]; then
            EXTRA="$EXTRA --anchor-friday '${{ inputs.anchor_friday }}'"
          fi
          if [ "${{ inputs.use_current_week }}" = "true" ]; then
            EXTRA="$EXTRA --use-current-week"
          fi

          python tools/scan_70d_highs.py \
            --since-days 130 \
            --top "${{ inputs.top || '10' }}" \
            --topvol "${{ inputs.topvol || '1000' }}" \
            --cap-min "${{ inputs.cap_min || '1000000000' }}" \
            --min-price "${{ inputs.min_price || '5' }}" \
            --min-dollar-vol "${{ inputs.min_dollar_vol || '10000000' }}" \
            --out-dir backtests \
            $EXTRA

      - name: Probe hi70 outputs
        shell: bash
        run: |
          set -e
          echo "[probe] listing:"
          find backtests -maxdepth 1 -type f -name "hi70_*" -printf '%p (%s bytes)\n' | sort || true
          CSV="$(find backtests -type f -name 'hi70_thisweek.csv' -print -quit || true)"
          if [ -n "$CSV" ]; then
            echo "[probe] head of CSV:"; sed -n '1,12p' "$CSV" || true
            echo "[probe] row count (excl header):"
            awk -F, 'NR>1 && $1!="" {c++} END{print c+0}' "$CSV" || true
          fi
          TXT="$(find backtests -type f -name 'hi70_digest.txt' -print -quit || true)"
          if [ -n "$TXT" ]; then
            echo "[probe] head of digest:"; sed -n '1,12p' "$TXT" || true
          fi

      - name: Upload 70D-highs artifact
        uses: actions/upload-artifact@v4
        with:
          name: hi70-${{ steps.when.outputs.friday }}
          path: |
            backtests/hi70_thisweek.csv
            backtests/hi70_digest.txt
          if-no-files-found: error
          retention-days: 7
