name: Weekly Picks & Ops

on:
  workflow_dispatch:
    inputs:
      mode:
        type: choice
        description: What to run
        options: [status, build, open, close]
        required: true
        default: status
      until:
        type: string
        description: Override "until" date (YYYY-MM-DD). Leave blank for today (Oslo).
        required: false
        default: ""
      topk:
        type: number
        description: How many symbols to act on (preview/email/open/close)
        required: false
        default: 6
      live:
        type: boolean
        description: Place *live* orders (true) or dry-run (false) for open/close
        required: false
        default: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Oslo

      # Secrets you must add in GitHub → Settings → Secrets and variables → Actions → New repository secret
      ALPACA_API_KEY_ID: ${{ secrets.ALPACA_API_KEY_ID }}
      ALPACA_API_SECRET_KEY: ${{ secrets.ALPACA_API_SECRET_KEY }}
      ALPACA_BASE_URL: ${{ secrets.ALPACA_BASE_URL }} # optional; defaults to paper if empty

      POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }} # needed for data refresh step

      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASS }}
      SMTP_TO:   ${{ secrets.SMTP_TO }} # comma-separated list or a single email

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy pyyaml requests tzdata alpaca-trade-api

      - name: Make working folders
        run: |
          mkdir -p backtests logs stock_data_400 universe

      - name: Compute UNTIL date and DRY flag
        id: when
        run: |
          if [[ -n "${{ inputs.until }}" ]]; then
            UNTIL="${{ inputs.until }}"
          else
            UNTIL="$(date +%F)"   # today in Europe/Oslo
          fi

          if [[ "${{ inputs.live }}" == "true" ]]; then
            DRY=""
          else
            DRY="--dry-run"
          fi

          echo "UNTIL=$UNTIL" >> $GITHUB_ENV
          echo "DRY=$DRY" >> $GITHUB_ENV
          echo "until=$UNTIL" >> $GITHUB_OUTPUT
          echo "dry=$DRY" >> $GITHUB_OUTPUT

      # ---------- Drop runtime configs from secrets ----------
      - name: Write config_highrsi.yaml
        run: |
          cat > config_highrsi.yaml <<'YAML'
          alpaca:
            api_key_id: "${ALPACA_API_KEY_ID}"
            secret_key: "${ALPACA_API_SECRET_KEY}"
            base_url: "${ALPACA_BASE_URL:-https://paper-api.alpaca.markets}"
          data_dir: stock_data_400
          picklist_path: backtests/picklist_highrsi_trend.csv

          # trading sizing/levels used by weekly_ops_highrsi.py
          topk: 6
          sizing: fixed_fraction_equal_weight
          stop_mult: 1.75
          target_mult: 4.0
          tp_mode: fixed          # live brackets use fixed TP
          use_prevclose: true
          anchor_levels: entry
          min_notional: 0

          close:
            method: cls
            cutoff_et: "15:50"
            fallback: market
          YAML

      - name: Write config_notify.yaml
        run: |
          cat > config_notify.yaml <<'YAML'
          email:
            smtp_server: smtp.gmail.com
            smtp_port: 587
            smtp_user: "${SMTP_USER}"
            smtp_password: "${SMTP_PASS}"
            # To keep recipients hidden, notify_picks.py will put these in BCC.
            recipients: "${SMTP_TO}"
            sender: "${SMTP_USER}"
            subject_prefix: "[Weekly picks]"
          YAML

      # ---------- MODE: BUILD (refresh data → build picklist → email) ----------
      - name: Refresh weekly universe (Polygon)
        if: ${{ inputs.mode == 'build' }}
        env:
          POLYGON_API_KEY: ${{ env.POLYGON_API_KEY }}
        run: |
          # Try your weekly updater; continue on warning if it fails.
          set -x
          python weekly_updater_top400_enhanced.py || echo "WARN: weekly_updater_top400_enhanced failed; continuing with any existing CSVs."

      - name: Build picklist (RSI≥68, rank=rsi)
        if: ${{ inputs.mode == 'build' }}
        run: |
          python build_picklist_parametric.py \
            --config config_highrsi.yaml \
            --since 2020-01-01 --until "${UNTIL}" \
            --preset classic --rsi-min 68 --rank rsi --max-ext20 0.15 --top-per-week 40 \
            --out backtests/picklist_highrsi_trend.csv

      - name: Preview Top-${{ inputs.topk }}
        if: ${{ inputs.mode == 'build' }}
        run: |
          python show_next_picks.py --picklist backtests/picklist_highrsi_trend.csv --topk ${{ inputs.topk }}

      - name: Email weekly picks
        if: ${{ inputs.mode == 'build' }}
        run: |
          python notify_picks.py --config config_notify.yaml \
            --picklist backtests/picklist_highrsi_trend.csv --topk ${{ inputs.topk }}

      - name: Upload build artifacts
        if: ${{ inputs.mode == 'build' }}
        uses: actions/upload-artifact@v4
        with:
          name: weekly-picks-${{ steps.when.outputs.until }}
          if-no-files-found: ignore
          path: |
            backtests/picklist_highrsi_trend.csv
            backtests/notifications/*.txt
            logs/**/*.log

      # ---------- MODE: STATUS ----------
      - name: Status (account + preview)
        if: ${{ inputs.mode == 'status' }}
        run: |
          python weekly_ops_highrsi.py --action status --config config_highrsi.yaml --topk ${{ inputs.topk }}

      # ---------- MODE: OPEN (market buys + bracket stops/TP from prev close) ----------
      - name: Open positions (Top-${{ inputs.topk }})  ${{ inputs.live && 'LIVE' || '(dry-run)' }}
        if: ${{ inputs.mode == 'open' }}
        run: |
          python weekly_ops_highrsi.py --action open --config config_highrsi.yaml --topk ${{ inputs.topk }} ${DRY}

      # ---------- MODE: CLOSE (CLS or market) ----------
      - name: Close positions via CLS (fallback market)  ${{ inputs.live && 'LIVE' || '(dry-run)' }}
        if: ${{ inputs.mode == 'close' }}
        run: |
          python weekly_ops_highrsi.py --action close --config config_highrsi.yaml \
            --close-method cls --close-cutoff-et "15:50" --close-fallback market ${DRY}
