name: Weekly Picks (manual)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: What to run
        type: choice
        options: [status, build, email_smoke, open, close]
        required: true
        default: build
      until:
        description: Override “until” date (YYYY-MM-DD). Blank = today (Oslo)
        required: false
        default: ""
      topk:
        description: How many symbols to show/send
        required: false
        default: "6"

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Oslo
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy pyyaml requests python-dateutil pytz tabulate
          pip install alpaca-trade-api

      - name: Compute UNTIL date and shell flags
        id: dates
        shell: bash
        run: |
          if [[ -n "${{ github.event.inputs.until }}" ]]; then
            UNTIL="${{ github.event.inputs.until }}"
          else
            UNTIL="$(date +%F)"
          fi
          echo "UNTIL=$UNTIL" >> $GITHUB_OUTPUT

      - name: Ensure folders
        run: |
          mkdir -p backtests notifications artifacts stock_data_400

      - name: Write config_highrsi.yaml
        run: |
          cat > config_highrsi.yaml <<'YAML'
          data_dir: stock_data_400
          preset: classic
          rsi_min: 68
          rank: rsi
          max_ext20: 0.15
          top_per_week: 40
          YAML

      - name: Write config_notify.yaml (Gmail, from secrets)
        run: |
          cat > config_notify.yaml <<'YAML'
          smtp:
            host: smtp.gmail.com
            port: 587
            user: "${{ secrets.SMTP_USER }}"
            password: "${{ secrets.SMTP_PASS }}"
            starttls: true
            from: "CEO of Kanute <${{ secrets.SMTP_USER }}>"
          recipients:
            - "${{ secrets.SMTP_TO }}"
          YAML

      - name: STATUS — show inputs and time
        run: |
          echo "Mode : ${{ github.event.inputs.mode }}"
          echo "Until: ${{ steps.dates.outputs.UNTIL }}"
          echo "TopK : ${{ github.event.inputs.topk || '6' }}"
          date

      # ---------- BUILD ----------
      - name: Build weekly picklist (RSI≥68, rank=rsi, max_ext20=0.15, Top-40/wk)
        if: startsWith(github.event.inputs.mode, 'build') || startsWith(github.event.inputs.mode, 'open') || startsWith(github.event.inputs.mode, 'close')
        run: |
          python build_picklist_parametric.py \
            --data-dir stock_data_400 \
            --out backtests/picklist_highrsi_trend.csv \
            --rsi-min 68 \
            --max-ext20 0.15 \
            --top-per-week 40 \
            --until "${{ steps.dates.outputs.UNTIL }}"

      - name: Preview Top-6 (inline)
        if: startsWith(github.event.inputs.mode, 'build')
        run: |
          python - <<'PY'
          import os, sys
          import pandas as pd
          topk = int(os.getenv('TOPK', '6'))
          path = 'backtests/picklist_highrsi_trend.csv'
          try:
              df = pd.read_csv(path)
              if 'week_start' not in df.columns or 'symbol' not in df.columns:
                  raise ValueError("picklist missing required columns (week_start, symbol)")
              wk = df['week_start'].max()
              sub = df[df['week_start'] == wk].copy()
              if 'rank' in sub.columns:
                  sub = sub.sort_values('rank')
              elif 'score' in sub.columns:
                  sub = sub.sort_values('score', ascending=False)
              syms = sub['symbol'].head(topk).tolist()
              print(f"Week start: {wk}")
              for i,s in enumerate(syms, 1):
                  print(f"{i:>2}  {s}")
              print("CSV:", ",".join(syms))
          except Exception as e:
              print(f"[WARN] Preview failed: {e}")
              sys.exit(0)
          PY
        env:
          TOPK: ${{ github.event.inputs.topk || '6' }}

      # ---------- EMAIL ----------
      - name: EMAIL_SMOKE — send test email (Bcc to SMTP_TO)
        if: github.event.inputs.mode == 'email_smoke'
        run: |
          python - <<'PY'
          import os, ssl, smtplib
          from email.message import EmailMessage
          msg = EmailMessage()
          msg['Subject'] = "Smoke test from GitHub Actions"
          msg['From'] = f"CEO of Kanute <{os.environ['SMTP_USER']}>"
          msg['To'] = os.environ['SMTP_USER']
          if os.environ.get('SMTP_TO'):
              msg['Bcc'] = os.environ['SMTP_TO']
          msg.set_content("If you see this, SMTP works.")
          with smtplib.SMTP('smtp.gmail.com', 587, timeout=30) as s:
              s.starttls(context=ssl.create_default_context())
              s.login(os.environ['SMTP_USER'], os.environ['SMTP_PASS'])
              s.send_message(msg)
          PY
        env:
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_TO:   ${{ secrets.SMTP_TO }}

      - name: Email weekly picks
        if: startsWith(github.event.inputs.mode, 'build')
        run: |
          python notify_picks.py \
            --config config_notify.yaml \
            --picklist backtests/picklist_highrsi_trend.csv \
            --topk ${{ github.event.inputs.topk || '6' }}

      # ---------- DRY OPS ----------
      - name: Open positions (Top-K) — DRY
        if: startsWith(github.event.inputs.mode, 'open')
        run: |
          python weekly_ops_highrsi.py \
            --action open \
            --config config_highrsi.yaml \
            --dry-run

      - name: Close positions (CLS; fallback market) — DRY
        if: startsWith(github.event.inputs.mode, 'close')
        run: |
          python weekly_ops_highrsi.py \
            --action close \
            --config config_highrsi.yaml \
            --close-method cls \
            --dry-run

      - name: Upload build artifacts
        if: startsWith(github.event.inputs.mode, 'build')
        uses: actions/upload-artifact@v4
        with:
          name: weekly-build
          path: |
            backtests/picklist_highrsi_trend.csv
            config_highrsi.yaml
            config_notify.yaml
