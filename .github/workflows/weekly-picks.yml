name: Weekly Picks (manual)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: What to run
        type: choice
        required: true
        default: status
        options: [status, email_smoke]
      until:
        description: Optional YYYY-MM-DD (not used in this minimal version)
        required: false
        default: ""
      topk:
        description: Optional number of symbols (not used here)
        required: false
        default: "6"

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Oslo
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASS }}
      SMTP_TO:   ${{ secrets.SMTP_TO }}
      SMTP_FROM: ${{ secrets.SMTP_FROM }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: STATUS — show inputs and time
        if: ${{ inputs.mode == 'status' }}
        run: |
          echo "mode=${{ inputs.mode }}"
          echo "until=${{ inputs.until }}"
          echo "topk=${{ inputs.topk }}"
          echo "date(Oslo): $(date)"

      - name: EMAIL_SMOKE — send test email (Bcc to SMTP_TO)
        if: ${{ inputs.mode == 'email_smoke' }}
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
        run: |
          python - << 'PY'
          import os, smtplib, ssl
          from email.message import EmailMessage
          env = os.environ.get
          user = env("SMTP_USER"); pwd = env("SMTP_PASS")
          to   = env("SMTP_TO");   frm = env("SMTP_FROM") or user
          host = env("SMTP_HOST") or "smtp.gmail.com"
          port = int(env("SMTP_PORT") or 587)

          if not (user and pwd and to):
              raise SystemExit("Missing SMTP secrets (SMTP_USER/SMTP_PASS/SMTP_TO).")
          print(f"SMTP host: {host}:{port}  (user domain: {user.split('@')[-1]})")

          msg = EmailMessage()
          msg["Subject"] = "CI smoke test: Weekly Picks mailer"
          msg["From"] = frm
          msg["To"] = frm
          msg["Bcc"] = to
          msg.set_content("Hello!\nThis is a smoke test from GitHub Actions.\nIf you see this, SMTP is OK.\n")

          ctx = ssl.create_default_context()
          with smtplib.SMTP(host, port, timeout=30) as s:
              s.starttls(context=ctx)
              s.login(user, pwd)
              s.send_message(msg)
              print("Sent via STARTTLS.")
          PY

