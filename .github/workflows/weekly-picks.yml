name: Weekly Picks (manual)

on:
  workflow_dispatch:
    inputs:
      mode:
        type: choice
        description: What to run
        required: true
        options: [status, build, open, close, email_smoke]
        default: build
      until:
        description: Override "until" date (YYYY-MM-DD). Blank = today (Oslo)
        required: false
        default: ""
      topk:
        description: How many symbols to preview / email
        required: false
        default: "6"

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Oslo
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASS }}
      SMTP_TO:   ${{ secrets.SMTP_TO }}
      SMTP_FROM: ${{ secrets.SMTP_FROM }}
      ALPACA_API_KEY_ID:     ${{ secrets.ALPACA_API_KEY_ID }}
      ALPACA_API_SECRET_KEY: ${{ secrets.ALPACA_API_SECRET_KEY }}
      ALPACA_BASE_URL:       ${{ secrets.ALPACA_BASE_URL || 'https://paper-api.alpaca.markets' }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy pyyaml requests python-dateutil

      - name: Compute UNTIL date and DRY flag
        id: when
        shell: python
        run: |
          import os, sys, datetime, zoneinfo
          tz = zoneinfo.ZoneInfo("Europe/Oslo")
          raw = "${{ inputs.until }}".strip()
          if raw:
            until = datetime.date.fromisoformat(raw)
          else:
            until = datetime.datetime.now(tz).date()
          # DRY for weekends by default
          dry = "1" if until.weekday() >= 5 else "0"
          print(f"UNTIL={until}", file=open(os.environ["GITHUB_OUTPUT"], "a"))
          print(f"DRY={dry}", file=open(os.environ["GITHUB_OUTPUT"], "a"))
          print(f"TopK=${{ inputs.topk }}  Mode=${{ inputs.mode }}  Until={until}")

      - name: STATUS — show inputs and time
        if: ${{ inputs.mode == 'status' }}
        run: |
          echo "Mode:       ${{ inputs.mode }}"
          echo "Until:      ${{ steps.when.outputs.UNTIL }}"
          echo "TopK:       ${{ inputs.topk }}"
          echo "Runner TZ:  $TZ"

      - name: Make working folders
        if: ${{ inputs.mode == 'build' }}
        run: |
          mkdir -p stock_data_400 backtests

      # OPTIONAL: refresh data if you later add sync_polygon_eod.py
      - name: Refresh weekly universe (Polygon) — optional
        if: ${{ inputs.mode == 'build' && hashFiles('sync_polygon_eod.py') != '' }}
        run: |
          python sync_polygon_eod.py --since 2020-01-01 --until "${{ steps.when.outputs.UNTIL }}" --qps-delay 0.35

      # BUILD picklist (requires build_picklist_parametric.py and CSVs in stock_data_400)
           - name: Build picklist (RSI≥68)
        if: ${{ github.event.inputs.mode == 'build' && hashFiles('stock_data_400/*.csv') != '' }}
        run: |
          python build_picklist_parametric.py \
            --data-dir stock_data_400 \
            --since 2020-01-01 \
            --preset classic \
            --rsi-min 68 \
            --rank rsi \
            --max-ext20 0.15 \
            --top-per-week 40 \
            $([ -n "${{ github.event.inputs.until }}" ] && echo --until ${{ github.event.inputs.until }}) \
            --out backtests/picklist_highrsi_trend.csv

      - name: Build skipped (no CSVs)
        if: ${{ github.event.inputs.mode == 'build' && hashFiles('stock_data_400/*.csv') == '' }}
        run: echo "No CSVs found in stock_data_400/*.csv — push data or adjust workflow."

          import os, sys, pandas as pd
          out = "backtests/picklist_highrsi_trend.csv"
          if not os.path.exists(out):
            print("No picklist to preview."); sys.exit(0)
          df = pd.read_csv(out)
          wk = df["week_start"].max()
          sub = df[df["week_start"]==wk].head(int("${{ inputs.topk }}"))
          print("Week start:", wk)
          print(sub[["symbol"]].to_string(index=False))

      - name: Email weekly picks
        if: ${{ inputs.mode == 'build' && env.SMTP_USER && env.SMTP_PASS && env.SMTP_TO }}
        shell: python
        run: |
          import os, smtplib, ssl, pandas as pd
          from email.message import EmailMessage
          out = "backtests/picklist_highrsi_trend.csv"
          if not os.path.exists(out):
            print("No picklist to email."); raise SystemExit(0)
          df = pd.read_csv(out)
          wk = df["week_start"].max()
          sub = df[df["week_start"]==wk].head(int("${{ inputs.topk }}"))
          body = "Weekly picks (Top {k}) — week_start {wk}\n\n{rows}\n\nGood trading,\nCEO of Kanute".format(
              k="${{ inputs.topk }}",
              wk=wk,
              rows="\n".join(f"  {i+1:>2}. {s}" for i,s in enumerate(sub["symbol"].tolist()))
          )
          msg = EmailMessage()
          msg["Subject"] = f"Weekly picks — {wk}"
          msg["From"] = os.environ.get("SMTP_FROM") or os.environ["SMTP_USER"]
          msg["To"] = (os.environ.get("SMTP_FROM") or os.environ["SMTP_USER"])
          # Hide recipients: put real list in BCC
          msg.set_content(body)
          bcc = [x.strip() for x in os.environ["SMTP_TO"].split(",") if x.strip()]
          ctx = ssl.create_default_context()
          with smtplib.SMTP("smtp.office365.com", 587, timeout=30) as s:
            s.starttls(context=ctx)
            s.login(os.environ["SMTP_USER"], os.environ["SMTP_PASS"])
            s.send_message(msg, to_addrs=[msg["To"], *bcc])
          print("Email sent to BCC list.")

      - name: Upload artifacts (picklist)
        if: ${{ inputs.mode == 'build' && exists('backtests/picklist_highrsi_trend.csv') }}
        uses: actions/upload-artifact@v4
        with:
          name: picklist
          path: backtests/picklist_highrsi_trend.csv

      # OPEN positions (optional — only if script exists)
      - name: Open positions (Top-K) — DRY
        if: ${{ inputs.mode == 'open' && hashFiles('weekly_ops_highrsi.py') != '' }}
        run: |
          python weekly_ops_highrsi.py --action open --config config_highrsi.yaml --dry-run --timings

      # CLOSE positions (optional — only if script exists)
      - name: Close positions via CLS (fallback market) — DRY
        if: ${{ inputs.mode == 'close' && hashFiles('weekly_ops_highrsi.py') != '' }}
        run: |
          python weekly_ops_highrsi.py --action close --config config_highrsi.yaml --dry-run

      - name: EMAIL_SMOKE — send test email (Bcc to SMTP_TO)
        if: ${{ inputs.mode == 'email_smoke' }}
        shell: python
        run: |
          import os, smtplib, ssl
          from email.message import EmailMessage
          msg = EmailMessage()
          msg["Subject"] = "SMTP smoke OK"
          msg["From"] = os.environ.get("SMTP_FROM") or os.environ["SMTP_USER"]
          msg["To"] = msg["From"]  # self
          msg.set_content("Hello from GitHub Actions.\nThis is a smoke test.\n")
          bcc = [x.strip() for x in os.environ["SMTP_TO"].split(",") if x.strip()]
          ctx = ssl.create_default_context()
          with smtplib.SMTP("smtp.office365.com", 587, timeout=30) as s:
            s.starttls(context=ctx)
            s.login(os.environ["SMTP_USER"], os.environ["SMTP_PASS"])
            s.send_message(msg, to_addrs=[msg["To"], *bcc])
          print("Smoke email sent.")
