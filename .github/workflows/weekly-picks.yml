name: Weekly Picks (manual)

on:
  workflow_dispatch:
    inputs:
      mode:
        type: choice
        description: What to run
        options: [status, build, email_smoke]
        required: true
        default: build
      until:
        description: Override "until" date (YYYY-MM-DD). Blank = today (Oslo)
        required: false
        default: ""
      topk:
        description: How many symbols to show/send
        required: false
        default: "6"

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Oslo

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy pyyaml pytz tzdata requests

      - name: Compute UNTIL date and shell flags
        id: compute
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${{ github.event.inputs.until || '' }}" ]]; then
            UNTIL=$(TZ=Europe/Oslo date +%F)
          else
            UNTIL="${{ github.event.inputs.until }}"
          fi
          echo "UNTIL=$UNTIL" >> $GITHUB_ENV
          echo "TOPK=${{ github.event.inputs.topk || '6' }}" >> $GITHUB_ENV

      - name: Ensure folders
        run: |
          mkdir -p backtests stock_data_400 notifications

      # ----- EMAIL CONFIG FROM SECRETS (Gmail) -----
      - name: Write config_notify.yaml (Gmail, from secrets)
        env:
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          SMTP_TO:   ${{ secrets.SMTP_TO }}
        shell: bash
        run: |
          set -euo pipefail
          : "${SMTP_USER:?Missing secret SMTP_USER}"
          : "${SMTP_PASS:?Missing secret SMTP_PASS}"
          : "${SMTP_TO:?Missing secret SMTP_TO}"
          {
            echo "smtp:"
            echo "  host: smtp.gmail.com"
            echo "  port: 587"
            echo "  user: \"${SMTP_USER}\""
            echo "  pass: \"${SMTP_PASS}\""
            echo "  from: \"${SMTP_FROM:-$SMTP_USER}\""
            echo "  to:"
            IFS=',' read -ra ADDR <<< "${SMTP_TO}"
            for a in "${ADDR[@]}"; do
              a_trimmed="$(echo "$a" | xargs)"
              echo "    - \"${a_trimmed}\""
            done
            echo "poems: []"
          } > config_notify.yaml

      - name: Show config_notify.yaml (redacted)
        shell: bash
        run: |
          sed -E 's/(pass: ).*/\1********/' config_notify.yaml

      - name: STATUS — show inputs and time
        if: ${{ github.event.inputs.mode == 'status' }}
        run: |
          echo "UNTIL=${UNTIL}"; echo "TOPK=${TOPK}"; date

      # ----- BUILD PICKLIST -----
      - name: Build weekly picklist (RSI>=68, rank=rsi, max_ext20=0.15, Top-40/wk)
        if: ${{ github.event.inputs.mode == 'build' }}
        shell: bash
        run: |
          python build_picklist_parametric.py \
            --data-dir stock_data_400 \
            --out backtests/picklist_highrsi_trend.csv \
            --rsi-min 68 \
            --max-ext20 0.15 \
            --top-per-week 40 \
            --until "${UNTIL}"

      # ----- INLINE PREVIEW (no external script needed) -----
      - name: Preview Top-6 (inline)
        if: ${{ github.event.inputs.mode == 'build' }}
        shell: bash
        run: |
          python - <<'PY'
          import os, pandas as pd, numpy as np
          path = 'backtests/picklist_highrsi_trend.csv'
          topk = int(os.environ.get('TOPK','6'))
          until = os.environ['UNTIL']
          if not os.path.exists(path):
              raise SystemExit(f"Picklist not found: {path}")
          df = pd.read_csv(path)
          # normalize column names
          df.columns = [c.strip().lower() for c in df.columns]
          if 'week_start' not in df.columns:
              if 'week_start_date' in df.columns:
                  df.rename(columns={'week_start_date':'week_start'}, inplace=True)
              else:
                  raise SystemExit("CSV missing 'week_start' column.")
          if 'symbol' not in df.columns:
              raise SystemExit("CSV missing 'symbol' column.")
          df['week_start'] = pd.to_datetime(df['week_start'], errors='coerce', utc=False)
          df = df.dropna(subset=['week_start'])
          until_dt = pd.to_datetime(until)
          latest = df.loc[df['week_start']<=until_dt, 'week_start'].max()
          if pd.isna(latest):
              raise SystemExit(f"No rows for week_start <= {until} in {path}")
          sub = df[df['week_start']==latest].copy()
          if 'rank' in sub.columns:
              sub = sub.sort_values('rank', ascending=True)
          elif 'score' in sub.columns:
              sub = sub.sort_values('score', ascending=False)
          out = sub.head(topk)[['symbol'] + [c for c in ('rank','score') if c in sub.columns]]
          print(f"Week start: {latest.date()} | Top-{topk}")
          print(out.to_string(index=False))
          PY

      - name: EMAIL_SMOKE — send test email (Bcc to SMTP_TO)
        if: ${{ github.event.inputs.mode == 'email_smoke' }}
        env:
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          SMTP_TO:   ${{ secrets.SMTP_TO }}
        shell: bash
        run: |
          python - <<'PY'
          import os, smtplib, ssl
          from email.message import EmailMessage
          to=os.environ.get("SMTP_TO","")
          to=[x.strip() for x in to.split(",") if x.strip()]
          msg=EmailMessage()
          msg["Subject"]="Smoke test from GitHub Actions"
          msg["From"]=os.environ.get("SMTP_FROM") or os.environ["SMTP_USER"]
          msg["To"]=os.environ["SMTP_USER"]
          if to: msg["Bcc"]=",".join(to)
          msg.set_content("Smoke test OK.")
          with smtplib.SMTP("smtp.gmail.com",587) as s:
              s.starttls(context=ssl.create_default_context())
              s.login(os.environ["SMTP_USER"],os.environ["SMTP_PASS"])
              s.send_message(msg)
          PY

      - name: Email weekly picks
        if: ${{ github.event.inputs.mode == 'build' }}
        shell: bash
        run: |
          python notify_picks.py --config config_notify.yaml --picklist backtests/picklist_highrsi_trend.csv --topk "${TOPK}"
