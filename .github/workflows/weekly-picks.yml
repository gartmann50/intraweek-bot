name: Weekly Picks (manual)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "What to run"
        type: choice
        required: true
        default: build
        options: [status, email_smoke, build]
      until:
        description: "Override until (YYYY-MM-DD). Blank = today (Oslo)"
        required: false
        default: ""
      topk:
        description: "How many symbols to show/send"
        required: false
        default: "6"

env:
  TZ: Europe/Oslo
  POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
  SMTP_USER: ${{ secrets.SMTP_USER }}
  SMTP_PASS: ${{ secrets.SMTP_PASS }}
  SMTP_TO:   ${{ secrets.SMTP_TO }}
  SMTP_FROM: ${{ secrets.SMTP_FROM }}

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout repo"
        uses: actions/checkout@v4

      - name: "Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "Install Python deps"
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests pyyaml python-dateutil pytz

      - name: "STATUS show inputs and time"
        if: ${{ inputs.mode == 'status' || inputs.mode == 'email_smoke' || inputs.mode == 'build' }}
        run: |
          python - <<'PY'
          import os, datetime, zoneinfo
          tz = zoneinfo.ZoneInfo(os.environ.get("TZ","UTC"))
          print("Now:", datetime.datetime.now(tz))
          print("Mode:", "${{ inputs.mode }}")
          print("Until input:", "${{ inputs.until }}")
          print("TopK:", "${{ inputs.topk }}")
          PY

      - name: "EMAIL_SMOKE send test email"
        if: ${{ inputs.mode == 'email_smoke' }}
        env:
          SMTP_HOST: smtp.office365.com
          SMTP_PORT: "587"
        run: |
          python - <<'PY'
          import os, smtplib, ssl
          from email.message import EmailMessage

          user=os.environ["SMTP_USER"]; pw=os.environ["SMTP_PASS"]
          host=os.environ.get("SMTP_HOST","smtp.office365.com")
          port=int(os.environ.get("SMTP_PORT","587"))
          to=os.environ["SMTP_TO"]; from_addr=os.environ.get("SMTP_FROM") or user

          msg=EmailMessage()
          msg["Subject"]="Smoke: CI can email"
          msg["From"]=from_addr
          msg["To"]=from_addr
          msg["Bcc"]=to
          msg.set_content("Hello from CI â€” this is a smoke test.\n")

          with smtplib.SMTP(host, port, timeout=30) as s:
            s.starttls(context=ssl.create_default_context())
            s.login(user,pw)
            s.send_message(msg)
          print("Smoke email sent.")
          PY

      - name: "Compute UNTIL date and DRY flag"
        if: ${{ inputs.mode == 'build' }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${{ inputs.until }}" ]; then
            UNTIL=$(python - <<'PY'
import datetime, zoneinfo
tz = zoneinfo.ZoneInfo("Europe/Oslo")
print(datetime.datetime.now(tz).date().isoformat())
PY
)
          else
            UNTIL="${{ inputs.until }}"
          fi
          echo "UNTIL_DATE=$UNTIL" >> "$GITHUB_ENV"
          echo "DRY_RUN=1" >> "$GITHUB_ENV"
          echo "TopK=${{ inputs.topk }}" >> "$GITHUB_ENV"
          echo "Until=$UNTIL"

      - name: "Ensure folders"
        if: ${{ inputs.mode == 'build' }}
        run: |
          mkdir -p stock_data_400 universe backtests notifications logs

      - name: "Make dynamic universe"
        if: ${{ inputs.mode == 'build' }}
        run: |
          python ci_make_universe.py \
            --out-file universe/dynamic_universe.txt \
            --max 700 \
            --source auto

      - name: "Refresh weekly universe (Polygon)"
        if: ${{ inputs.mode == 'build' && env.POLYGON_API_KEY }}
        run: |
          python ci_refresh_universe.py \
            --universe-file universe/dynamic_universe.txt \
            --since 2020-01-01 \
            --until "${{ env.UNTIL_DATE }}" \
            --data-dir stock_data_400 \
            --qps-delay 0.25

      - name: "Build picklist RSI>=68 rank=rsi"
        if: ${{ inputs.mode == 'build' }}
        run: |
          python build_picklist_parametric.py \
            --data-dir stock_data_400 \
            --rsi-min 68 \
            --max-ext20 0.15 \
            --top-per-week 40 \
            --until "${{ env.UNTIL_DATE }}" \
            --out backtests/picklist_highrsi_trend.csv

      - name: "Preview TopK"
        if: ${{ inputs.mode == 'build' }}
        run: |
          python show_next_picks.py --picklist backtests/picklist_highrsi_trend.csv --topk "${{ env.TopK }}"

      - name: "Write config_notify.yaml"
        if: ${{ inputs.mode == 'build' }}
        run: |
          cat > config_notify.yaml <<'YAML'
          smtp:
            host: smtp.office365.com
            port: 587
            user: "${{ secrets.SMTP_USER }}"
            password: "${{ secrets.SMTP_PASS }}"
            from: "${{ secrets.SMTP_FROM }}"
            to: "${{ secrets.SMTP_TO }}"
          email:
            subject_prefix: "Weekly picks"
            signoff: "Good trading,\nCEO of Kanute"
          YAML
          sed -n '1,999p' config_notify.yaml

      - name: "Email weekly picks"
        if: ${{ inputs.mode == 'build' }}
        run: |
          python notify_picks.py --config config_notify.yaml --picklist backtests/picklist_highrsi_trend.csv --topk "${{ env.TopK }}"
