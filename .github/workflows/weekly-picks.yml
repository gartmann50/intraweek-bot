name: Weekly Picks (manual)

on:
  workflow_dispatch:
    inputs:
      mode:
        type: choice
        description: What to run
        options: [status, build, email_smoke]
        required: true
        default: build
      until:
        description: Override "until" date (YYYY-MM-DD). Blank = today (Oslo)
        required: false
        default: ""
      topk:
        description: How many symbols to show/send
        required: false
        default: "6"

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Oslo

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy pyyaml pytz tzdata requests

      - name: Compute UNTIL date and shell flags
        id: compute
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${{ github.event.inputs.until || '' }}" ]]; then
            UNTIL=$(TZ=Europe/Oslo date +%F)
          else
            UNTIL="${{ github.event.inputs.until }}"
          fi
          echo "UNTIL=$UNTIL" >> $GITHUB_ENV
          echo "TOPK=${{ github.event.inputs.topk || '6' }}" >> $GITHUB_ENV

      - name: Ensure folders
        run: |
          mkdir -p backtests stock_data_400 notifications

      # ----- EMAIL CONFIG FROM SECRETS (Gmail) -----
      - name: Write config_notify.yaml (Gmail, from secrets)
        env:
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          SMTP_TO:   ${{ secrets.SMTP_TO }}
        shell: bash
        run: |
          set -euo pipefail
          : "${SMTP_USER:?Missing secret SMTP_USER}"
          : "${SMTP_PASS:?Missing secret SMTP_PASS}"
          : "${SMTP_TO:?Missing secret SMTP_TO}"
          {
            echo "smtp:"
            echo "  host: smtp.gmail.com"
            echo "  port: 587"
            echo "  user: \"${SMTP_USER}\""
            echo "  pass: \"${SMTP_PASS}\""
            echo "  from: \"${SMTP_FROM:-$SMTP_USER}\""
            echo "  to:"
            IFS=',' read -ra ADDR <<< "${SMTP_TO}"
            for a in "${ADDR[@]}"; do
              a_trimmed="$(echo "$a" | xargs)"
              echo "    - \"${a_trimmed}\""
            done
            echo "poems: []"
          } > config_notify.yaml

      - name: Show config_notify.yaml (redacted)
        shell: bash
        run: |
          sed -E 's/(pass: ).*/\1********/' config_notify.yaml

      - name: STATUS — show inputs and time
        if: ${{ github.event.inputs.mode == 'status' }}
        run: |
          echo "UNTIL=${UNTIL}"; echo "TOPK=${TOPK}"; date

      # ----- BUILD PICKLIST -----
      - name: Build weekly picklist (RSI>=68, rank=rsi, max_ext20=0.15, Top-40/wk)
        if: ${{ github.event.inputs.mode == 'build' }}
        shell: bash
        run: |
          python build_picklist_parametric.py \
            --data-dir stock_data_400 \
            --out backtests/picklist_highrsi_trend.csv \
            --rsi-min 68 \
            --max-ext20 0.15 \
            --top-per-week 40 \
            --until "${UNTIL}"

      # ----- INLINE PREVIEW (no external script needed) -----
      - name: Preview Top-6 (inline)
        shell: bash
        run: |
          python - <<'PY'
          import pandas as pd
          from datetime import datetime, timezone, date
          from pathlib import Path
          import os, sys

          PICKLIST = os.environ.get("PICKLIST", "backtests/picklist_highrsi_trend.csv")
          TOPK = int(os.environ.get("TOPK", "6"))
          # If your workflow computes UNTIL (e.g., YYYY-MM-DD for Oslo “today”), we’ll use it;
          # otherwise we fallback to local “today”.
          UNTIL = os.environ.get("UNTIL", "")

    def today_local() -> date:
        return datetime.now(timezone.utc).astimezone().date()

    def choose_week(ws, override):
        if override:
            try:
                want = pd.to_datetime(override, errors="raise").date()
            except Exception:
                return None
              return want if want in set(ws) else None
             t = today_local()
             future = ws[ws >= t]
        if len(future):
            return min(future)
            past = ws[ws <= t]
            return max(past) if len(past) else None

    p = Path(PICKLIST)
    if not p.exists():
        print(f"::warning::Picklist not found: {p}")
        sys.exit(0)

    df_raw = pd.read_csv(p)
    if "week_start" not in df_raw.columns:
        print("::warning::Picklist missing 'week_start' column")
        sys.exit(0)

    df = df_raw.copy()
    df["week_start_date"] = pd.to_datetime(df["week_start"], errors="coerce").dt.date
    ws = df["week_start_date"].dropna()
    if ws.empty:
        print("::warning::No valid dates in week_start")
        sys.exit(0)

    wk = choose_week(ws, UNTIL)
    if wk is None:
        print(f"::warning::Could not choose a week. Last few weeks: {sorted(set(ws))[-10:]}")
        sys.exit(0)

    block = df[df["week_start_date"] == wk].copy()
    if block.empty:
        print(f"::warning::No rows for week_start={wk}")
        sys.exit(0)

    sym_col = "symbol" if "symbol" in block.columns else ("ticker" if "ticker" in block.columns else None)
    if not sym_col:
        print("::warning::Picklist needs 'symbol' or 'ticker' column")
        sys.exit(0)

    # Sort by rank (asc) if present, else by score (desc) if present
    if "rank" in block.columns:
        block = block.sort_values("rank", ascending=True)
    elif "score" in block.columns:
        block = block.sort_values("score", ascending=False)

    top = [str(x).strip().upper() for x in block[sym_col].head(TOPK).tolist()]
    print(f"\n=== Weekly picks — week of {wk} ===")
    if not top:
        print("::warning::Top-K list is empty after filtering/sorting.")
        sys.exit(0)

    for i, s in enumerate(top, 1):
        print(f"{i:>2}. {s}")
    print(f"\nCSV: {','.join(top)}\n")
    PY
  env:
    PICKLIST: backtests/picklist_highrsi_trend.csv
    TOPK: ${{ inputs.topk || '6' }}
    # If your workflow already computes an UNTIL date, pass it:
    UNTIL: ${{ steps.until.outputs.date || '' }}


      - name: EMAIL_SMOKE — send test email (Bcc to SMTP_TO)
        if: ${{ github.event.inputs.mode == 'email_smoke' }}
        env:
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          SMTP_TO:   ${{ secrets.SMTP_TO }}
        shell: bash
        run: |
          python - <<'PY'
          import os, smtplib, ssl
          from email.message import EmailMessage
          to=os.environ.get("SMTP_TO","")
          to=[x.strip() for x in to.split(",") if x.strip()]
          msg=EmailMessage()
          msg["Subject"]="Smoke test from GitHub Actions"
          msg["From"]=os.environ.get("SMTP_FROM") or os.environ["SMTP_USER"]
          msg["To"]=os.environ["SMTP_USER"]
          if to: msg["Bcc"]=",".join(to)
          msg.set_content("Smoke test OK.")
          with smtplib.SMTP("smtp.gmail.com",587) as s:
              s.starttls(context=ssl.create_default_context())
              s.login(os.environ["SMTP_USER"],os.environ["SMTP_PASS"])
              s.send_message(msg)
          PY

      - name: Email weekly picks
  # only send on a build/open/close run; keep if-condition you already use
        if: ${{ github.event.inputs.mode == 'build' || startsWith(github.event.inputs.mode, 'open_') || startsWith(github.event.inputs.mode, 'close') }}
        env:
    # feed secrets to the script via environment (no need for a config file)
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_TO:   ${{ secrets.SMTP_TO }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          TOPK:      ${{ github.event.inputs.topk || '6' }}
        run: |
          python notify_picks.py \
            --picklist backtests/picklist_highrsi_trend.csv \
            --topk "${TOPK}"
