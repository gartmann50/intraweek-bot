name: Weekly Picks

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Choose action: status, build, open_dry, open_live, close_dry, close_live, email_smoke"
        required: true
        default: "status"
        type: choice
        options:
          - status
          - build
          - open_dry
          - open_live
          - close_dry
          - close_live
          - email_smoke
      until:
        description: "YYYY-MM-DD to build up to (Oslo date). Leave blank to auto use last Friday."
        required: false
        default: ""

jobs:
  weekly:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      # Secrets for mail & Alpaca
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      RECIPIENTS: ${{ secrets.RECIPIENTS }}
      ALPACA_API_KEY_ID: ${{ secrets.ALPACA_API_KEY_ID }}
      ALPACA_API_SECRET_KEY: ${{ secrets.ALPACA_API_SECRET_KEY }}
      ALPACA_BASE_URL: ${{ secrets.ALPACA_BASE_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install pandas numpy pyyaml alpaca-trade-api pytz

      - name: Compute UNTIL date (most recent Friday in Oslo if empty)
        id: dates
        shell: python
        run: |
          import os, json
          from datetime import datetime, timedelta
          from zoneinfo import ZoneInfo
          until = "${{ github.event.inputs.until }}".strip()
          if not until:
            now_oslo = datetime.now(ZoneInfo("Europe/Oslo")).date()
            d = now_oslo
            while d.weekday() != 4:  # Friday
              d -= timedelta(days=1)
            until = d.isoformat()
          print("UNTIL=", until)
          with open(os.environ['GITHUB_OUTPUT'], "a") as fh:
            fh.write(f"until={until}\n")

      - name: Write config_notify.yaml from secrets (runner only)
        run: |
          cat > config_notify.yaml <<'YAML'
          email:
            user: "${GMAIL_USER}"
            app_password: "${GMAIL_APP_PASSWORD}"
            recipients_bcc: "${RECIPIENTS}"
            subject_prefix: "Weekly picks"
          YAML
          echo "Wrote config_notify.yaml"

      - name: Status (list top 6 for latest week)  # safe, no trading
        if: ${{ github.event.inputs.mode == 'status' }}
        run: |
          python show_next_picks.py --picklist backtests/picklist_highrsi_trend.csv --topk 6 || true

     - name: Build weekly picklist (RSIâ‰¥68, max_ext20=0.15, Top-40/wk)
    shell: bash
    run: |
    python build_picklist_parametric.py \
      --data-dir stock_data_400 \
      --out backtests/picklist_highrsi_trend.csv \
      --rsi-min 68 \
      --max-ext20 0.15 \
      --top-per-week 40 \
      --until "${{ env.UNTIL }}"


      - name: Refresh company names (for nicer emails)
        if: ${{ github.event.inputs.mode == 'build' || startsWith(github.event.inputs.mode, 'open_') || github.event.inputs.mode == 'email_smoke' }}
        run: |
          python refresh_symbol_names.py || true

      - name: Email picks (smoke -> no poem; build -> full poem & names)
        if: ${{ github.event.inputs.mode == 'email_smoke' || github.event.inputs.mode == 'build' }}
        run: |
          if [ "${{ github.event.inputs.mode }}" = "email_smoke" ]; then
            python notify_picks.py --config config_notify.yaml --picklist backtests/picklist_highrsi_trend.csv --topk 6 --no-poem
          else
            python notify_picks.py --config config_notify.yaml --picklist backtests/picklist_highrsi_trend.csv --topk 6
          fi

      - name: Write live config for Alpaca (runner only)
        if: ${{ startsWith(github.event.inputs.mode, 'open_') || startsWith(github.event.inputs.mode, 'close_') }}
        run: |
          cat > config_live.yaml <<'YAML'
          alpaca:
            api_key_id: "${ALPACA_API_KEY_ID}"
            secret_key: "${ALPACA_API_SECRET_KEY}"
            base_url: "${ALPACA_BASE_URL}"
          data_dir: stock_data_400
          topk: 6
          sizing: fixed_fraction_equal_weight
          stop_mult: 1.75
          target_mult: 4.0
          tp_mode: fixed
          use_prevclose: true
          anchor_levels: entry
          min_notional: 0
          picklist_path: backtests/picklist_highrsi_trend.csv
          close:
            method: cls
            cutoff_et: "15:50"
            fallback: market
          YAML
          echo "Wrote config_live.yaml"

      - name: Open (DRY)
        if: ${{ github.event.inputs.mode == 'open_dry' }}
        run: |
          python weekly_ops_highrsi.py --action open --config config_live.yaml --dry-run

      - name: Open (LIVE)
        if: ${{ github.event.inputs.mode == 'open_live' }}
        run: |
          python weekly_ops_highrsi.py --action open --config config_live.yaml

      - name: Close (DRY)
        if: ${{ github.event.inputs.mode == 'close_dry' }}
        run: |
          python weekly_ops_highrsi.py --action close --config config_live.yaml --close-method cls --dry-run

      - name: Close (LIVE)
        if: ${{ github.event.inputs.mode == 'close_live' }}
        run: |
          python weekly_ops_highrsi.py --action close --config config_live.yaml --close-method cls
