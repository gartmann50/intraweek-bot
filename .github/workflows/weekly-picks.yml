name: Weekly Picks (manual)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: What to run
        required: true
        type: choice
        default: status
        options: [status, build, open, close, email_smoke]
      until:
        description: Override "until" date (YYYY-MM-DD). Blank = today (Oslo)
        required: false
        default: ""
      topk:
        description: How many symbols to show/send
        required: false
        default: "6"

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Oslo
      # Secrets (set these in Settings → Secrets and variables → Actions)
      ALPACA_API_KEY_ID: ${{ secrets.ALPACA_API_KEY_ID }}
      ALPACA_API_SECRET_KEY: ${{ secrets.ALPACA_API_SECRET_KEY }}
      ALPACA_BASE_URL: ${{ secrets.ALPACA_BASE_URL || 'https://paper-api.alpaca.markets' }}
      POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASS }}
      SMTP_TO:   ${{ secrets.SMTP_TO }}
      SMTP_FROM: ${{ secrets.SMTP_FROM }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy pyyaml requests python-dateutil

      - name: STATUS — show inputs and time
        run: |
          echo "mode:  ${{ inputs.mode }}"
          echo "until: ${{ inputs.until }}"
          echo "topk:  ${{ inputs.topk }}"
          date

      - name: Compute UNTIL date and DRY flag
        id: when
        shell: bash
        run: |
          if [[ -n "${{ inputs.until }}" ]]; then
            UNTIL="${{ inputs.until }}"
          else
            UNTIL="$(TZ=Europe/Oslo date +%F)"
          fi
          echo "until=$UNTIL" >> "$GITHUB_OUTPUT"
          if [[ "${{ inputs.mode }}" == "open" || "${{ inputs.mode }}" == "close" ]]; then
            echo "dry=no" >> "$GITHUB_OUTPUT"
          else
            echo "dry=yes" >> "$GITHUB_OUTPUT"
          fi
          echo "UNTIL: $UNTIL  DRY: $(cat $GITHUB_OUTPUT | sed -n 's/^dry=//p')"

      - name: Ensure folders
        run: |
          mkdir -p universe backtests stock_data_400 notifications

      # Optional: pull a fresh symbol universe from Polygon (names only).
      # This does NOT download price history; it just writes universe/polygon_universe.csv
      - name: Refresh weekly universe (Polygon)
        if: ${{ inputs.mode != 'status' && env.POLYGON_API_KEY != '' }}
        env:
          POLYGON_API_KEY: ${{ env.POLYGON_API_KEY }}
        run: |
          python - <<'PY'
          import os, requests, pandas as pd
          key = os.environ.get("POLYGON_API_KEY","")
          if not key:
              print("No POLYGON_API_KEY; skipping.")
              raise SystemExit(0)
          url = f"https://api.polygon.io/v3/reference/tickers?market=stocks&active=true&limit=1000&apiKey={key}"
          syms=[]
          while url:
              r = requests.get(url, timeout=30)
              r.raise_for_status()
              data = r.json()
              for t in data.get("results", []):
                  ex = (t.get("primary_exchange") or "").upper()
                  if ex in ("NYSE","NASDAQ","AMEX"):
                      s = t.get("ticker","")
                      if s.isupper() and s.isalpha() and 1 <= len(s) <= 5:
                          syms.append(s)
              url = data.get("next_url")
              if url and "apiKey=" not in url:
                  url += f"&apiKey={key}"
          syms = sorted(set(syms))
          pd.DataFrame({"symbol": syms}).to_csv("universe/polygon_universe.csv", index=False)
          print("Universe size:", len(syms))
          PY

      - name: Write config_highrsi.yaml
        run: |
          cat > config_highrsi.yaml <<'YAML'
          data_dir: stock_data_400
          until: "${{ steps.when.outputs.until }}"
          rsi_min: 68
          rank: rsi
          max_ext20: 0.15
          top_per_week: 40
          topk: ${{ inputs.topk }}
          YAML

      - name: Write config_notify.yaml
        run: |
          cat > config_notify.yaml <<'YAML'
          smtp:
            user: "${{ env.SMTP_USER }}"
            password: "${{ env.SMTP_PASS }}"
            to: "${{ env.SMTP_TO }}"
            from: "${{ env.SMTP_FROM }}"
          footer: |
            Good trading — very good.
            CEO of Kanute
          subject_prefix: "Weekly picks"
          YAML

      - name: EMAIL_SMOKE — send test email (Bcc to SMTP_TO)
        if: ${{ inputs.mode == 'email_smoke' }}
        env:
          SMTP_USER: ${{ env.SMTP_USER }}
          SMTP_PASS: ${{ env.SMTP_PASS }}
          SMTP_TO:   ${{ env.SMTP_TO }}
          SMTP_FROM: ${{ env.SMTP_FROM }}
        run: |
          python - <<'PY'
          import os, smtplib
          u=os.environ["SMTP_USER"]; p=os.environ["SMTP_PASS"]
          to=os.environ["SMTP_TO"]; sender=os.environ.get("SMTP_FROM",u)
          msg=("From: %s\r\nTo: %s\r\nBcc: %s\r\nSubject: Smoke test\r\n\r\n"
               "This is a smoke test from GitHub Actions.\r\n") % (sender, sender, to)
          with smtplib.SMTP("smtp.gmail.com", 587, timeout=30) as s:
              s.starttls(); s.login(u, p); s.sendmail(sender, [sender]+to.split(","), msg)
          print("Smoke email sent.")
          PY

      - name: Build picklist (RSI≥68, rank=rsi)
        if: ${{ inputs.mode == 'build' }}
        # NOTE: this expects your repo to already contain CSVs in stock_data_400/.
        # If you want the runner to download history from Polygon too, tell me and
        # I’ll add a (heavier) sync step.
        run: |
          if [[ "${{ steps.when.outputs.until }}" == "" ]]; then echo "No UNTIL"; exit 1; fi
          python build_picklist_parametric.py \
            --data-dir stock_data_400 \
            --out backtests/picklist_highrsi_trend.csv \
            --since 2020-01-01 \
            --preset classic \
            --rsi-min 68 \
            --rank rsi \
            --max-ext20 0.15 \
            --top-per-week 40 \
            --until "${{ steps.when.outputs.until }}"

      - name: Preview Top-${{ inputs.topk }}
        if: ${{ inputs.mode == 'build' }}
        run: |
          python show_next_picks.py --picklist backtests/picklist_highrsi_trend.csv --topk ${{ inputs.topk }}

      - name: Email weekly picks
        if: ${{ inputs.mode == 'build' }}
        run: |
          python notify_picks.py --config config_notify.yaml --picklist backtests/picklist_highrsi_trend.csv --topk ${{ inputs.topk }}

      - name: Open positions (Top-K) LIVE
        if: ${{ inputs.mode == 'open' }}
        run: |
          python weekly_ops_highrsi.py --action open --config config_highrsi.yaml

      - name: Close positions (CLS; fallback market) LIVE
        if: ${{ inputs.mode == 'close' }}
        run: |
          python weekly_ops_highrsi.py --action close --config config_highrsi.yaml
