name: IW Bot — Friday Build

on:
  schedule:
    - cron: "25 21 * * 5"     # Friday after US close (EST)
    - cron: "25 20 * * 5"     # Friday after US close (EDT)
  workflow_dispatch:
    inputs:
      topk:
        description: "Top-K to preview/email"
        required: false
        default: "6"

concurrency:
  group: iwbot-friday-build
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read

    env:
      TOPK: ${{ inputs.topk || '6' }}

    steps:
      - uses: actions/checkout@v4

      # --- Safety: ensure NO local datasets ever ---
      - name: Remove any local dataset dir
        run: rm -rf stock_data_400

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy requests pyyaml matplotlib pillow
        env:
          MPLBACKEND: Agg

      # --- Compute Friday anchor ---
      - name: Compute last Friday (Europe/Oslo)
        id: when
        shell: python
        run: |
          from datetime import datetime, timedelta
          from zoneinfo import ZoneInfo
          import os, json

          tz = ZoneInfo("Europe/Oslo")
          d = datetime.now(tz).date()
          while d.weekday() != 4:
              d -= timedelta(days=1)

          monday = (d + timedelta(days=3)).isoformat()

          with open("runner_dates.json","w") as f:
              json.dump({"friday": d.isoformat(), "monday": monday}, f)

          with open(os.environ["GITHUB_OUTPUT"],"a") as g:
              g.write(f"friday={d}\n")
              g.write(f"monday={monday}\n")

      - name: Export WEEK
        run: echo "WEEK=${{ steps.when.outputs.monday }}" >> $GITHUB_ENV

      # --- Build dynamic universe ONCE ---
      - name: Build universe (ADV$) with fallback
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: |
          set -euo pipefail
          python tools/make_universe_topvol.py \
            --adv-days 21 \
            --topvol 1000 \
            --min-price 5 \
            --out-dir backtests

          N=$(wc -l < backtests/universe_topvol.txt)
          echo "[universe] size=$N"

          if [ "$N" -lt 800 ]; then
            python tools/make_universe_topvol.py \
              --adv-days 21 \
              --topvol 1200 \
              --min-price 3 \
              --out-dir backtests
          fi

      # --- Build picklist (API ONLY) ---
      - name: Build picklist (API only, no local data)
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: |
          python build_picklist_parametric.py \
            --symbols-file backtests/universe_topvol.txt \
            --rsi-min 68 \
            --max-ext20 0.15 \
            --top-per-week 40 \
            --lookback-days 45 \
            --until "${{ steps.when.outputs.friday }}" \
            --out backtests/picklist_highrsi_trend.csv

      # --- Assert local data never sneaks back ---
      - name: Assert no local dataset present
        run: |
          test ! -d stock_data_400 && echo "OK: no stock_data_400 directory"

      # --- Trend filter ---
      - name: Filter light short-term trend
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: |
          python tools/filter_trend_light.py \
            --picklist backtests/picklist_highrsi_trend.csv \
            --out backtests/picklist_highrsi_trend.csv \
            --anchor-friday "${{ steps.when.outputs.friday }}" \
            --weeks 4 \
            --max-consecutive-down 1 \
            --down-eps 0.002

      # --- Enforce universe ---
      - name: Filter picklist by universe
        run: |
          python tools/filter_picklist_by_symbols.py \
            backtests/universe_topvol.txt \
            backtests/picklist_highrsi_trend.csv \
            backtests/picklist_highrsi_trend.csv

      # --- Preview Top-K ---
      - name: Preview Top-K
        run: |
          python preview_top6.py \
            --picklist backtests/picklist_highrsi_trend.csv \
            --topk "${{ env.TOPK }}" \
            --week "${{ steps.when.outputs.friday }}" \
            > backtests/top6_preview.txt

      # --- Optional hi70 ---
      - name: Download hi70 artifact
        if: always()
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: hi70-scan.yml
          workflow_conclusion: success
          name_is_regexp: true
          name: ^hi70-.*$
          path: backtests
          if_no_artifact_found: warn

      # --- Charts + email ---
      - name: Build email assets
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: |
          python tools/make_email_assets.py \
            --picklist backtests/picklist_highrsi_trend.csv \
            --topk "${{ env.TOPK }}"

      -  name: Email weekly summary (HTML + inline charts)
         env:
            SMTP_HOST: smtp.gmail.com
            SMTP_PORT: "587"
            SMTP_USER: ${{ secrets.SMTP_USER }}
            SMTP_PASS: ${{ secrets.SMTP_PASS }}
            SMTP_FROM: ${{ secrets.SMTP_FROM }}
            SMTP_TO:   ${{ secrets.SMTP_TO }}
            EMAIL_SUBJECT: "IW Bot — Weekly Picks ${{ steps.when.outputs.friday }}"
         run: |
            python tools/send_weekly_html.py




      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: weekly-picks-${{ steps.when.outputs.friday }}
          path: |
            backtests/picklist_highrsi_trend.csv
            backtests/top6_preview.txt
            runner_dates.json
