name: IW Bot — Friday Build

on:
  schedule:
    - cron: "25 21 * * 5"     # Friday after U.S. close (EST)
    - cron: "25 20 * * 5"     # Friday after U.S. close (EDT)
  workflow_dispatch:
    inputs:
      topk:
        description: "Top-K to preview/email"
        required: false
        default: "6"

concurrency:
  group: iwbot-friday-build
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read   # <— required to download artifacts from other workflow runs
    env:
      TOPK:  ${{ inputs.topk != '' && inputs.topk || '6' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: |
          python -m pip install --upgrade pip
          pip install pandas numpy pyyaml requests
      - name: Compute last Friday (Europe/Oslo)
        id: when
        shell: python
        run: |
          from datetime import datetime, timedelta
          import zoneinfo, os, json
          tz=zoneinfo.ZoneInfo("Europe/Oslo"); now=datetime.now(tz).date()
          while now.weekday()!=4: now-=timedelta(days=1)
          mon=(now+timedelta(days=3)).isoformat()
          with open("runner_dates.json","w") as f: json.dump({"friday":now.isoformat(),"monday":mon},f)
          open(os.environ["GITHUB_OUTPUT"],"a").write(f"friday={now}\n")
      
      - name: Export WEEK (nominal Monday) for later steps
        run: echo "WEEK=${{ steps.when.outputs.monday }}" >> $GITHUB_ENV

      
      
      - name: Cache dataset between runs
        uses: actions/cache@v4
        with:
          path: stock_data_400
          key: polygon-dataset-${{ steps.when.outputs.friday }}
          restore-keys: polygon-dataset-
      - name: Fetch dataset + build picklist
        run: |
          python build_picklist_parametric.py \
            --data-dir stock_data_400 \
            --rsi-min 68 --max-ext20 0.15 --top-per-week 40 \
            --until "${{ steps.when.outputs.friday }}" \
            --out backtests/picklist_highrsi_trend.csv
      - name: Preview Top-K (save file)
        run: |
          set -e
           python preview_top6.py \
            --picklist backtests/picklist_highrsi_trend.csv \
            --topk "${{ inputs.topk != '' && inputs.topk || '6' }}" \
            --week "${{ steps.when.outputs.friday }}" \
            > backtests/top6_preview.txt

      - name: Download 70D-highs artifact (if available)
        if: always()
        uses: dawidd6/action-download-artifact@v2
        with:
          repo: ${{ github.repository }}
          workflow: hi70-scan.yml           # the workflow that builds the 70D-highs artifact
          workflow_conclusion: success
          branch: main
          name_is_regexp: true
          name: ^hi70-.*$                   # match any hi70-* artifact name
          path: backtests
          allow_forks: true
          if_no_artifact_found: warn        # <- don't fail the job if it’s missing

      
      - name: Email config (from secrets)
        run: |
          cat > config_notify.yaml <<'YAML'
          # primary keys
          smtp_user: ${{ secrets.SMTP_USER }}
          smtp_pass: ${{ secrets.SMTP_PASS }}
          smtp_from: ${{ secrets.SMTP_FROM }}
          smtp_to:   ${{ secrets.SMTP_TO }}
          host: smtp.gmail.com
          port: 587
          use_tls: true

          # aliases some scripts expect
          from: ${{ secrets.SMTP_FROM }}
          to:   ${{ secrets.SMTP_TO }}
          YAML

      - name: Email weekly picks + 70D highs
        env:
         SMTP_USER: ${{ secrets.SMTP_USER }}
         SMTP_PASS: ${{ secrets.SMTP_PASS }}
         SMTP_TO:   ${{ secrets.SMTP_TO }}
         SMTP_FROM: ${{ secrets.SMTP_FROM }}
        run: |
          python - <<'PY'
          import os, sys, pathlib
          import yaml, smtplib
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart
          from email.mime.base import MIMEBase
          from email import encoders

          # ---- load config file (you write this earlier) and fall back to env ----
          cfg = {}
          p = pathlib.Path('config_notify.yaml')
          if p.exists():
              cfg = yaml.safe_load(p.read_text()) or {}
          smtp_user = cfg.get('smtp_user') or os.getenv('SMTP_USER')
          smtp_pass = cfg.get('smtp_pass') or os.getenv('SMTP_PASS')
          smtp_to   = cfg.get('smtp_to')   or os.getenv('SMTP_TO')
          smtp_from = cfg.get('smtp_from') or cfg.get('from') or os.getenv('SMTP_FROM')

          if not smtp_from:
              print("FATAL: smtp_from / from / SMTP_FROM is empty")
              sys.exit(1)

          host = cfg.get('host', 'smtp.gmail.com')
          port = int(cfg.get('port', 587))
          use_tls = bool(cfg.get('use_tls', True))

          # ---- build message (weekly picks body + optional 70D digest/CSV) ----
          subject = "Weekly picks + 70D highs"
          body = ""
          picks_preview = pathlib.Path('backtests/top6_preview.txt')
          if picks_preview.exists():
              body += picks_preview.read_text()
          digest = pathlib.Path('backtests/hi70_digest.txt')
          if digest.exists():
              body += "\n\n" + digest.read_text()

          msg = MIMEMultipart()
          msg['From'] = smtp_from
          msg['To']   = smtp_to
          msg['Subject'] = subject
          msg.attach(MIMEText(body or "(no content)", 'plain'))

          attach_csv = pathlib.Path('backtests/hi70_thisweek.csv')
          if attach_csv.exists():
              part = MIMEBase('application', 'octet-stream')
              part.set_payload(attach_csv.read_bytes())
              encoders.encode_base64(part)
              part.add_header('Content-Disposition', f'attachment; filename="{attach_csv.name}"')
              msg.attach(part)

          # ---- send ----
          with smtplib.SMTP(host, port, timeout=30) as s:
              if use_tls:
                  s.starttls()
              if smtp_user and smtp_pass:
                  s.login(smtp_user, smtp_pass)
              s.sendmail(smtp_from, [e.strip() for e in smtp_to.replace(';',',').split(',') if e.strip()], msg.as_string())
          print("Email sent.")
          PY
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: weekly-picks-${{ steps.when.outputs.friday }}
          path: |
            backtests/picklist_highrsi_trend.csv
            backtests/top6_preview.txt
            runner_dates.json
