name: IW Bot — Friday Build

on:
  schedule:
    - cron: "25 21 * * 5"     # Friday after U.S. close (EST)
    - cron: "25 20 * * 5"     # Friday after U.S. close (EDT)
  workflow_dispatch:
    inputs:
      topk:
        description: "Top-K to preview/email"
        required: false
        default: "6"

concurrency:
  group: iwbot-friday-build
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read   # <— required to download artifacts from other workflow runs
    env:
      TOPK:  ${{ inputs.topk != '' && inputs.topk || '6' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: |
          python -m pip install --upgrade pip
          pip install pandas numpy pyyaml requests
      - name: Compute last Friday (Europe/Oslo)
        id: when
        shell: python
        run: |
          from datetime import datetime, timedelta
          import zoneinfo, os, json
          tz=zoneinfo.ZoneInfo("Europe/Oslo"); now=datetime.now(tz).date()
          while now.weekday()!=4: now-=timedelta(days=1)
          mon=(now+timedelta(days=3)).isoformat()
          with open("runner_dates.json","w") as f: json.dump({"friday":now.isoformat(),"monday":mon},f)
          open(os.environ["GITHUB_OUTPUT"],"a").write(f"friday={now}\n")
      
      - name: Export WEEK (nominal Monday) for later steps
        run: echo "WEEK=${{ steps.when.outputs.monday }}" >> $GITHUB_ENV

      
      
      - name: Cache dataset between runs
        uses: actions/cache@v4
        with:
          path: stock_data_400
          key: polygon-dataset-${{ steps.when.outputs.friday }}
          restore-keys: polygon-dataset-
      - name: Fetch dataset + build picklist
        run: |
          python build_picklist_parametric.py \
            --data-dir stock_data_400 \
            --rsi-min 68 --max-ext20 0.15 --top-per-week 40 \
            --until "${{ steps.when.outputs.friday }}" \
            --out backtests/picklist_highrsi_trend.csv
      - name: Preview Top-K (save file)
        run: |
          set -e
           python preview_top6.py \
            --picklist backtests/picklist_highrsi_trend.csv \
            --topk "${{ inputs.topk != '' && inputs.topk || '6' }}" \
            --week "${{ steps.when.outputs.friday }}" \
            > backtests/top6_preview.txt

      - name: Download 70D-highs artifact (if available)
        if: always()
        uses: dawidd6/action-download-artifact@v2
        with:
          repo: ${{ github.repository }}
          workflow: hi70-scan.yml           # the workflow that builds the 70D-highs artifact
          workflow_conclusion: success
          branch: main
          name_is_regexp: true
          name: ^hi70-.*$                   # match any hi70-* artifact name
          path: backtests
          allow_forks: true
          if_no_artifact_found: warn        # <- don't fail the job if it’s missing

      - name: Build combined email body (picks + 70D highs)
        shell: bash
        run: |
          python - <<'PY'
          import os, sys, csv, glob, io
      
          out_path = "email_body.txt"
          parts = []
      
          # ------- Picks section (try a few common files/artifacts) -------
          picks_txt = None
          for pat in (
              "backtests/top6_preview.txt",
              "backtests/top6_preview.md",
              "backtests/weekly-picks-*.txt",
              "backtests/weekly_picks_*.txt",
          ):
              m = glob.glob(pat)
              if m:
                  picks_txt = m[0]
                  break
      
          if picks_txt and os.path.getsize(picks_txt) > 0:
              with open(picks_txt, "r", encoding="utf-8", errors="ignore") as f:
                  parts.append("WEEKLY PICKS\n=============\n" + f.read().strip())
          else:
              # Fall back to a CSV view if a text preview isn't present
              picks_csv = None
              for pat in (
                  "backtests/picklist_highrsi_trend.csv",
                  "backtests/weekly-picks-*.csv",
              ):
                  m = glob.glob(pat)
                  if m:
                      picks_csv = m[0]
                      break
              if picks_csv and os.path.getsize(picks_csv) > 0:
                  buf = io.StringIO()
                  buf.write("WEEKLY PICKS (from CSV)\n=======================\n")
                  try:
                      with open(picks_csv, newline="", encoding="utf-8") as f:
                          r = csv.reader(f)
                          hdr = next(r, [])
                          # show up to 10 rows for the email body
                          for _ in range(10):
                              row = next(r, None)
                              if row is None:
                                  break
                              buf.write(", ".join(row) + "\n")
                  except Exception as e:
                      buf.write(f"(could not read {picks_csv}: {e})\n")
                  parts.append(buf.getvalue())
              else:
                  parts.append("WEEKLY PICKS\n=============\n(no picks preview found)")
      
          # ------- 70D highs section -------
          hi_digest = None
          for pat in ("backtests/hi70_digest.txt", "backtests/hi70/hi70_digest.txt"):
              m = glob.glob(pat)
              if m:
                  hi_digest = m[0]
                  break
      
          if hi_digest and os.path.getsize(hi_digest) > 0:
              with open(hi_digest, "r", encoding="utf-8", errors="ignore") as f:
                  parts.append("\n\n70-DAY HIGHS\n============\n" + f.read().strip())
          else:
              parts.append("\n\n70-DAY HIGHS\n============\n(hi70 scan artifact not found or empty this week)")
      
          body = "\n\n".join(parts).strip() + "\n"
          with open(out_path, "w", encoding="utf-8") as out:
              out.write(body)
          print(f"Wrote {out_path} ({len(body)} bytes)")
          PY
      
            
            - name: Email config (from secrets)
              run: |
                cat > config_notify.yaml <<'YAML'
                # primary keys
                smtp_user: ${{ secrets.SMTP_USER }}
                smtp_pass: ${{ secrets.SMTP_PASS }}
                smtp_from: ${{ secrets.SMTP_FROM }}
                smtp_to:   ${{ secrets.SMTP_TO }}
                host: smtp.gmail.com
                port: 587
                use_tls: true
      
                # aliases some scripts expect
                from: ${{ secrets.SMTP_FROM }}
                to:   ${{ secrets.SMTP_TO }}
                YAML

      - name: Email picks + 70D highs (single email)
        env:
          SMTP_TO:    ${{ secrets.SMTP_TO }}
          SMTP_FROM:  ${{ secrets.SMTP_FROM }}
          SMTP_HOST:  ${{ secrets.SMTP_HOST }}
          SMTP_PORT:  ${{ secrets.SMTP_PORT }}   # "465" for SSL or "587" for STARTTLS (defaults to 465)
          SMTP_USER:  ${{ secrets.SMTP_USER }}   # optional; defaults to SMTP_FROM
          SMTP_PASS:  ${{ secrets.SMTP_PASS }}   # optional; if empty, login is skipped
        shell: python
        run: |
          import os, ssl, smtplib, sys
          from email.message import EmailMessage

          body = r"""${{ steps.emsg.outputs.body }}"""

          host = os.environ.get("SMTP_HOST", "").strip()
          if not host:
              sys.exit("FATAL: SMTP_HOST is empty")

          port = int(os.environ.get("SMTP_PORT", "465") or "465")
          from_addr = os.environ["SMTP_FROM"]
          to_addr   = os.environ["SMTP_TO"]
          user      = os.environ.get("SMTP_USER") or from_addr
          password  = os.environ.get("SMTP_PASS", "")

          msg = EmailMessage()
          msg["Subject"] = "Weekly picks + 70D highs"
          msg["From"]    = from_addr
          msg["To"]      = to_addr
          msg.set_content(body)

          ctx = ssl.create_default_context()

          # SSL on 465
          if port == 465:
              with smtplib.SMTP_SSL(host, port, context=ctx, timeout=30) as s:
                  if password:
                      s.login(user, password)
                  s.send_message(msg)
          else:
              # Plain SMTP with optional STARTTLS (common on 587)
              with smtplib.SMTP(host, port, timeout=30) as s:
                  s.ehlo()
                  if port == 587:
                      s.starttls(context=ctx)
                      s.ehlo()
                  if password:
                      s.login(user, password)
                  s.send_message(msg)
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: weekly-picks-${{ steps.when.outputs.friday }}
          path: |
            backtests/picklist_highrsi_trend.csv
            backtests/top6_preview.txt
            runner_dates.json
