name: IW Bot â€” MCP Intent Runner

on:
  repository_dispatch:
    types: [trade-intent]   # <- Claude/MCP will post this

concurrency:
  group: iwbot-mcp-intent
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  run-intent:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: python -m pip install --upgrade pip requests pandas
      - name: Execute intent
        env:
          # Payload comes from repository_dispatch.client_payload
          INTENT_JSON: ${{ toJson(github.event.client_payload) }}

          # Your existing keys/env
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    live           # or paper while testing

          # Safety rails (override in repo secrets if you like)
          INTENT_CAP_USD:    ${{ secrets.INTENT_CAP_USD || '10000' }}
          INTENT_ALLOWLIST:  ${{ secrets.INTENT_ALLOWLIST || '' }}   # e.g. "VLO,MPC,AGM,ARDX,AGI,AVDX"
          ALLOW_FRACTIONAL:  ${{ secrets.ALLOW_FRACTIONAL || 'false' }}
        run: python tools/intent_runner.py
