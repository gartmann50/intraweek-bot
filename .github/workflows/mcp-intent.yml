name: MCP Intent Runner

on:
  repository_dispatch:
    types: [mcp-intent]

jobs:
  run-mcp-intent:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Write MCP payload to file
        run: |
          cat << 'EOF' > mcp_payload.json
          ${{ toJson(github.event.client_payload) }}
          EOF

      - name: Run MCP Intent Runner
        env:
          # ---- Alpaca (from GitHub Secrets) ----
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_API_SECRET: ${{ secrets.ALPACA_API_SECRET }}
          # Paper trading URL by default; change if you go live
          ALPACA_BASE_URL: ${{ secrets.ALPACA_BASE_URL }}

          # ---- Polygon (from GitHub Secrets) ----
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}

          # ---- Safety toggle ----
          # "PAPER" for testing, "PROD" when you're ready for live trades
          TRADING_ENV: ${{ secrets.TRADING_ENV }}
        run: |
          python tools/mcp_intent_runner.py \
            --payload-file mcp_payload.json
