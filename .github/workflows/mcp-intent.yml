name: MCP Intent Runner

on:
  repository_dispatch:
    types: [trading_intent]
  workflow_dispatch:
    inputs:
      action:
        description: 'Action (buy/sell/close/query)'
        required: true
        type: choice
        options:
          - buy
          - sell
          - close
          - query
      symbol:
        description: 'Symbol (e.g., AAPL)'
        required: false
        type: string
      quantity:
        description: 'Quantity (shares)'
        required: false
        type: string
      query_type:
        description: 'Query type (account/positions/orders)'
        required: false
        type: choice
        options:
          - account
          - positions
          - orders

jobs:
  process-intent:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install alpaca-trade-api polygon-api-client
      
      - name: Build intent JSON (repository_dispatch)
        if: github.event_name == 'repository_dispatch'
        run: |
          echo '${{ toJson(github.event.client_payload) }}' > intent.json
          cat intent.json
      
      - name: Build intent JSON (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          cat > intent.json << EOF
          {
            "action": "${{ inputs.action }}",
            "symbol": "${{ inputs.symbol }}",
            "quantity": ${{ inputs.quantity || 'null' }},
            "type": "${{ inputs.query_type }}"
          }
          EOF
          cat intent.json
      
      - name: Process intent
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY_ID }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_API_SECRET_KEY }}
          ALPACA_BASE_URL: ${{ secrets.ALPACA_BASE_URL }}
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          UNIVERSE_FILE: data/universe_liquid.txt
        run: |
          python tools/mcp_intent_runner.py intent.json > result.json
          cat result.json
      
      - name: Upload result
        uses: actions/upload-artifact@v3
        with:
          name: intent-result
          path: result.json
      
      - name: Comment result on issue (if applicable)
        if: github.event.client_payload.issue_number
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const result = JSON.parse(fs.readFileSync('result.json', 'utf8'));
            
            const comment = `## Trading Intent Result
            
            **Status:** ${result.status}
            **Action:** ${result.action}
            
            \`\`\`json
            ${JSON.stringify(result, null, 2)}
            \`\`\`
            `;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.client_payload.issue_number }},
              body: comment
            });
