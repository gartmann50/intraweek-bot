name: IW Bot — Market Open

on:
  schedule:
    - cron: "25 12 * * 1-5"   # pre-open (EST)
    - cron: "25 13 * * 1-5"   # pre-open (EDT)
  workflow_dispatch:
    inputs:
      force_buy:
        description: "Force weekly buy now"
        type: boolean
        default: false

concurrency:
  group: iwbot-open
  cancel-in-progress: true

jobs:
  open:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions:  read   # <-- REQUIRED to download artifacts from other workflow runs
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: |
          python -m pip install --upgrade pip
          pip install pandas numpy requests
      - name: Compute last Friday
        id: when
        shell: python
        run: |
          from datetime import datetime, timedelta
          import zoneinfo, os
          tz=zoneinfo.ZoneInfo("Europe/Oslo"); d=datetime.now(tz).date()
          while d.weekday()!=4: d-=timedelta(days=1)
          open(os.environ["GITHUB_OUTPUT"],"a").write(f"friday={d}\n")
      - name: Download artifacts (picks + trailing)
        uses: dawidd6/action-download-artifact@v2
        with:
          repo: ${{ github.repository }}
          workflow: friday-build.yml          # <-- the workflow file that creates the picklist
          workflow_conclusion: success
          search_artifacts: true
          name_is_regexp: true
          name: ^(weekly-picks-|trailing-stops-).*
          path: backtests
          if_no_artifact_found: fail
      
      - name: Normalize picklist path
        shell: bash
        run: |
           set -euo pipefail
           shopt -s globstar nullglob
           # find the file no matter which artifact folder it sits under
           cand=(backtests/**/picklist_highrsi_trend.csv backtests/picklist_highrsi_trend.csv)
           for f in "${cand[@]}"; do
              if [[ -f "$f" ]]; then
              cp -f "$f" backtests/picklist_highrsi_trend.csv
              echo "Picklist copied from $f"
              exit 0
            fi
           done
           echo "ERROR: picklist_highrsi_trend.csv not found in downloaded artifacts"
           exit 1

      - name: Sanity — show backtests/
        run: ls -Rlh backtests || true

      - name: Download trailing exits (if any)
        uses: dawidd6/action-download-artifact@v2
        with:
          search_artifacts: true
          workflow: afterclose-trailing.yml
          name: trailing-stops-${{ steps.when.outputs.friday }}
          path: backtests
          if_no_artifact_found: ignore
      - name: Gate to U.S. open (sleep ≤2h)
        id: gate
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper
          FORCE_BUY:     ${{ inputs.force_buy }}
        shell: python
        run: |
          import os, time, sys, requests, datetime as dt
          if os.getenv("FORCE_BUY","false").lower()=="true":
              open(os.environ["GITHUB_OUTPUT"],"a").write("go=1\n"); sys.exit(0)
          base="https://paper-api.alpaca.markets" if os.getenv("ALPACA_ENV","paper").startswith("paper") else "https://api.alpaca.markets"
          H={"APCA-API-KEY-ID":os.environ["ALPACA_KEY"],"APCA-API-SECRET-KEY":os.environ["ALPACA_SECRET"]}
          c=requests.get(f"{base}/v2/clock",headers=H,timeout=20).json()
          if c.get("is_open"): open(os.environ["GITHUB_OUTPUT"],"a").write("go=1\n"); sys.exit(0)
          t=dt.datetime.fromisoformat(c["next_open"].replace("Z","+00:00"))
          sec=max(0,(t-dt.datetime.now(dt.timezone.utc)).total_seconds())
          if sec>7200: open(os.environ["GITHUB_OUTPUT"],"a").write("go=0\n"); sys.exit(0)
          time.sleep(int(sec)+3); open(os.environ["GITHUB_OUTPUT"],"a").write("go=1\n")
      - name: Execute exits at open (if any)
        if: ${{ steps.gate.outputs.go == '1' }}
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper
        run: |
          if [ -s backtests/exit_symbols.txt ]; then
            python execute_orders.py \
              --broker alpaca \
              --data-dir stock_data_400 \
              --picklist backtests/picklist_highrsi_trend.csv \
              --week "${{ steps.when.outputs.friday }}" \
              --side sell
          else
            echo "No exits."
          fi
      - name: Decide if first session after Friday
        if: ${{ steps.gate.outputs.go == '1' }}
        id: buygate
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper
        shell: python
        run: |
          import os,requests,datetime as dt
          from zoneinfo import ZoneInfo
          base="https://paper-api.alpaca.markets" if os.getenv("ALPACA_ENV","paper").startswith("paper") else "https://api.alpaca.markets"
          H={"APCA-API-KEY-ID":os.environ["ALPACA_KEY"],"APCA-API-SECRET-KEY":os.environ["ALPACA_SECRET"]}
          friday="${{ steps.when.outputs.friday }}"
          start=(dt.date.fromisoformat(friday)+dt.timedelta(days=1)).isoformat()
          end  =(dt.date.fromisoformat(friday)+dt.timedelta(days=7)).isoformat()
          cal=requests.get(f"{base}/v2/calendar",params={"start":start,"end":end},headers=H,timeout=20).json()
          first=(cal[0]["date"] if cal else None)
          today=dt.datetime.now(dt.timezone.utc).astimezone(ZoneInfo("America/New_York")).date().isoformat()
          do="1" if first and today==first else "0"
          open(os.environ["GITHUB_OUTPUT"],"a").write(f"do={do}\n")
          print("first:",first,"today:",today,"BUY=",do)
      - name: Prepare buy list (Top-K)
        if: ${{ steps.gate.outputs.go == '1' && steps.buygate.outputs.do == '1' }}
        run: |
          python - <<'PY'
          import os, pandas as pd, pathlib as p
          df=pd.read_csv('backtests/picklist_highrsi_trend.csv')
          wk='week_start' if 'week_start' in df.columns else 'week'
          w=str(pd.to_datetime(df[wk],errors='coerce').dropna().dt.date.max())
          picks=(df[pd.to_datetime(df[wk],errors='coerce').dt.date.astype(str)==w]['symbol']
                   .dropna().astype(str).head(6).tolist())
          p.Path('backtests').mkdir(exist_ok=True); open('backtests/buy_symbols.txt','w').write("\n".join(picks))
          print("picks:",picks)
          PY
      
      - name: Preflight Top-K before buying (why/why-not)
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper
          NOTIONAL_PER:  "5000"                 # keep in sync with your buy step
          TOPK:          ${{ env.TOPK || '6' }} # or hardcode "6"
        shell: python
        run: |
          import os, sys, json, glob, pathlib, requests, pandas as pd
          data_dir = "stock_data_400"
          pick = pathlib.Path("backtests/picklist_highrsi_trend.csv")
          if not pick.exists():
              print("ERROR: picklist missing:", pick); sys.exit(78)

          df = pd.read_csv(pick)
          wkcol = "week_start" if "week_start" in df.columns else ("week" if "week" in df.columns else None)
          if not wkcol:
              print("ERROR: no week column in picklist"); sys.exit(1)

          # WEEK from env (set earlier in your job) or latest in picklist:
          week = os.environ.get("WEEK")
          if not week:
              week = str(pd.to_datetime(df[wkcol], errors="coerce").dropna().dt.date.max())
          print("Chosen WEEK:", week)

          # Top-K list for that week
          k = int(os.getenv("TOPK", "6"))
          sel = df[pd.to_datetime(df[wkcol], errors="coerce").dt.date.astype(str) == week].copy()
          if "rank" in sel.columns: sel = sel.sort_values(["rank","symbol"], ascending=[True,True])
          elif "score" in sel.columns: sel = sel.sort_values(["score","symbol"], ascending=[False,True])
          picks = sel["symbol"].dropna().astype(str).head(k).tolist()
          print("Top-K:", picks)
          if not picks:
              print("No picks for WEEK → nothing to buy."); sys.exit(0)

          # Alpaca clock
          base = "https://paper-api.alpaca.markets" if os.getenv("ALPACA_ENV","paper").startswith("paper") else "https://api.alpaca.markets"
          H = {"APCA-API-KEY-ID": os.environ["ALPACA_KEY"], "APCA-API-SECRET-KEY": os.environ["ALPACA_SECRET"]}
          r = requests.get(f"{base}/v2/clock", headers=H, timeout=20)
          is_open = (r.status_code == 200 and (r.json() or {}).get("is_open", False))
          print("Alpaca clock is_open:", is_open)

          # helper: last close from your local EOD CSVs
          def last_close(sym):
              for p in sorted(glob.glob(f"{data_dir}/{sym}*.csv")):
                  try:
                      d = pd.read_csv(p, usecols=[0,4])  # Date, Close
                      if len(d): return float(d.iloc[-1,1])
                  except Exception:
                      pass
              return None

          notional = float(os.getenv("NOTIONAL_PER","0") or 0)
          print(f"Notional per name: {notional:,.2f} USD")

          # asset checks
          for s in picks:
              a = requests.get(f"{base}/v2/assets/{s}", headers=H, timeout=20)
              tradable, frac = False, False
              if a.status_code == 200:
                  aj = a.json() or {}
                  tradable = bool(aj.get("tradable", False))
                  frac     = bool(aj.get("fractionable", False))
              lc = last_close(s)
              reasons = []
              if not tradable: reasons.append("NOT_TRADABLE")
              if not frac and lc is not None and notional < lc: reasons.append(f"NOT_FRACTIONABLE & notional<{lc:.2f}")
              if lc is None: reasons.append("NO_LOCAL_EOD")
              if reasons:
                  print(f"- {s}: SKIP → {', '.join(reasons)}")
              else:
                  print(f"- {s}: OK (tradable={tradable}, fractionable={frac}, last_close={lc})")

          if not is_open:
              print("NOTE: Market is closed; Alpaca will typically reject DAY market orders. Run this during open or gate to open.")

      - name: Derive WEEK from picklist (export)
        shell: python
        run: |
          import os, pandas as pd
          p = 'backtests/picklist_highrsi_trend.csv'
          df = pd.read_csv(p)
          wk = 'week_start' if 'week_start' in df.columns else ('week' if 'week' in df.columns else None)
          if not wk:
              raise SystemExit("No week column (week_start/week) in picklist.")
          week = str(pd.to_datetime(df[wk], errors='coerce').dropna().dt.date.max())
          print("WEEK =", week)
          open(os.environ['GITHUB_ENV'], 'a').write(f'WEEK={week}\n')

      
      - name: Buy once (long-only)
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper
          NOTIONAL_PER:  "5000"
          TOPK:          ${{ env.TOPK || '6' }}
        shell: bash
        run: |
          set -e

          echo "NOTIONAL_PER=$NOTIONAL_PER"
          echo "WEEK=$WEEK  TOPK=${TOPK}"

          # (optional) show Top-K for this WEEK
          python - <<'PY'
          import os, pandas as pd
          p='backtests/picklist_highrsi_trend.csv'
          df=pd.read_csv(p)
          wk='week_start' if 'week_start' in df.columns else 'week'
          week=os.environ['WEEK']
          k=int(os.getenv('TOPK','6'))
          if 'rank' in df.columns: df=df.sort_values(['rank','symbol'], ascending=[True,True])
          elif 'score' in df.columns: df=df.sort_values(['score','symbol'], ascending=[False,True])
          picks=(df[pd.to_datetime(df[wk], errors='coerce').dt.date.astype(str)==week]['symbol']
                 .dropna().astype(str).head(k).tolist())
          print(f"Picks (Top-{k}) for WEEK={week}: {','.join(picks)}")
          PY

          # gate to open (max 2h) so DAY orders aren’t rejected
          python - <<'PY'
          import os, sys, time, requests, datetime as dt
          base = "https://paper-api.alpaca.markets" if os.getenv("ALPACA_ENV","paper").startswith("paper") else "https://api.alpaca.markets"
          h = {"APCA-API-KEY-ID": os.environ["ALPACA_KEY"], "APCA-API-SECRET-KEY": os.environ["ALPACA_SECRET"]}
          r = requests.get(f"{base}/v2/clock", headers=h, timeout=20)
          c = r.json() if r.status_code==200 else {}
          if c.get("is_open"): sys.exit(0)
          nxt = c.get("next_open")
          if not nxt: sys.exit(0)
          t = dt.datetime.fromisoformat(nxt.replace("Z","+00:00"))
          now = dt.datetime.now(dt.timezone.utc)
          wait = (t-now).total_seconds()
          if 0 < wait <= 7200:
              print(f"Market closed; sleeping {int(wait)}s until open...")
              time.sleep(int(wait))
          PY

          python execute_orders.py \
            --broker alpaca \
            --data-dir stock_data_400 \
            --picklist backtests/picklist_highrsi_trend.csv \
            --week "${WEEK}" \
            --topk "${TOPK}" \
            --side buy \
            --notional "${NOTIONAL_PER}" \
            --init-stop-atr-mult 1.75


      - name: Inspect orders file
        shell: bash
        run: |
          set -e
          f=$(ls -1 backtests/orders_*.json | tail -n1)
          echo "== $f =="
          cat "$f"

      - name: Show Alpaca positions (paper)
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
        run: python tools/moc_flatten.py
