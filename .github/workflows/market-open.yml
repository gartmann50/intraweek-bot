name: IW Bot — Market Open

on:
  schedule:
    # Keep Mon–Fri so a Monday market holiday still buys on Tuesday
    - cron: "25 12 * * 1-5"   # pre-open (EST window)
    - cron: "25 13 * * 1-5"   # pre-open (EDT window)
  workflow_dispatch:
    inputs:
      force_buy:
        description: "Force weekly buy now"
        type: boolean
        default: false

# If you truly want Monday-only (and skip Tuesday on holidays), replace the
# two cron lines above with these two:
#   - cron: "25 14 * * 1"   # 09:25 EST (UTC+5)
#   - cron: "25 13 * * 1"   # 09:25 EDT (UTC+4)

concurrency:
  group: iwbot-open
  cancel-in-progress: true

jobs:
  open:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read   # <-- REQUIRED to download artifacts from other workflow runs

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: |
          python -m pip install --upgrade pip
          pip install pandas numpy requests

      # --- Compute last Friday AND whether it's Monday in New York ---
      - name: When (NY)
        id: when
        shell: python
        run: |
          from datetime import datetime, timedelta
          from zoneinfo import ZoneInfo
          import os
          ny = ZoneInfo("America/New_York")
          now = datetime.now(ny)
          d = now.date()
          # last Friday
          while d.weekday() != 4:
              d -= timedelta(days=1)
          is_monday = (now.weekday() == 0)
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"friday={d}\n")
              f.write(f"is_monday={'true' if is_monday else 'false'}\n")


      # --- Duplicate-buy guard per week (keyed by Friday date) ---
      - name: Dup guard for this Friday
        id: opened
        uses: actions/cache@v4
        with:
          path: .open-flag
          key: opened-${{ steps.when.outputs.friday }}

      - name: Exit if already opened this week
        if: steps.opened.outputs.cache-hit == 'true' && github.event.inputs.force_buy != 'true'
        run: echo "Already opened for ${{ steps.when.outputs.friday }}; exiting." && exit 0

      - name: List recent artifacts (debug)
        run: gh run artifacts --limit 20 || true
        env:
           GH_TOKEN: ${{ github.token }}

      - name: Download weekly picks artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: friday-build.yml
          branch: main
          workflow_conclusion: success
          name: ^weekly-picks-${{ steps.when.outputs.friday }}$
          name_is_regexp: true
          path: backtests
          if_no_artifact_found: fail

      - name: Download trailing stops
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: friday-build.yml
          branch: main
          workflow_conclusion: success
          name: ^trailing-stops-${{ steps.when.outputs.friday }}$
          name_is_regexp: true
          path: backtests
          if_no_artifact_found: warn

      - name: Normalize picklist path
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar nullglob
          cand=(backtests/**/picklist_highrsi_trend.csv backtests/picklist_highrsi_trend.csv)
          for f in "${cand[@]}"; do
            if [[ -f "$f" ]]; then
              cp -f "$f" backtests/picklist_highrsi_trend.csv
              echo "Picklist copied from $f"
              exit 0
            fi
          done
          echo "ERROR: picklist_highrsi_trend.csv not found in downloaded artifacts"
          exit 1

      - name: Sanity — show backtests/
        run: ls -Rlh backtests || true

      - name: Download trailing exits (if any)
        uses: dawidd6/action-download-artifact@v2
        with:
          search_artifacts: true
          workflow: afterclose-trailing.yml
          name: trailing-stops-${{ steps.when.outputs.friday }}
          path: backtests
          if_no_artifact_found: ignore

      - name: Gate to U.S. open (sleep ≤2h)
        id: gate
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper
          FORCE_BUY:     ${{ github.event.inputs.force_buy }}
        shell: python
        run: |
          import os, time, sys, requests, datetime as dt
          if str(os.getenv("FORCE_BUY","false")).lower()=="true":
              open(os.environ["GITHUB_OUTPUT"],"a").write("go=1\n"); sys.exit(0)
          base="https://paper-api.alpaca.markets" if os.getenv("ALPACA_ENV","paper").startswith("paper") else "https://api.alpaca.markets"
          H={"APCA-API-KEY-ID":os.environ["ALPACA_KEY"],"APCA-API-SECRET-KEY":os.environ["ALPACA_SECRET"]}
          c=requests.get(f"{base}/v2/clock",headers=H,timeout=20).json()
          if c.get("is_open"): open(os.environ["GITHUB_OUTPUT"],"a").write("go=1\n"); sys.exit(0)
          t=dt.datetime.fromisoformat(c["next_open"].replace("Z","+00:00"))
          sec=max(0,(t-dt.datetime.now(dt.timezone.utc)).total_seconds())
          if sec>7200: open(os.environ["GITHUB_OUTPUT"],"a").write("go=0\n"); sys.exit(0)
          time.sleep(int(sec)+3); open(os.environ["GITHUB_OUTPUT"],"a").write("go=1\n")

      - name: Execute exits at open (if any)
        if: ${{ steps.gate.outputs.go == '1' }}
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper
        run: |
          if [ -s backtests/exit_symbols.txt ]; then
            python execute_orders.py \
              --broker alpaca \
              --data-dir stock_data_400 \
              --picklist backtests/picklist_highrsi_trend.csv \
              --week "${{ steps.when.outputs.friday }}" \
              --side sell
          else
            echo "No exits."
          fi

      - name: Decide if first session after Friday
        if: ${{ steps.gate.outputs.go == '1' }}
        id: buygate
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper
        shell: python
        run: |
          import os,requests,datetime as dt
          from zoneinfo import ZoneInfo
          base="https://paper-api.alpaca.markets" if os.getenv("ALPACA_ENV","paper").startswith("paper") else "https://api.alpaca.markets"
          H={"APCA-API-KEY-ID":os.environ["ALPACA_KEY"],"APCA-API-SECRET-KEY":os.environ["ALPACA_SECRET"]}
          friday="${{ steps.when.outputs.friday }}"
          start=(dt.date.fromisoformat(friday)+dt.timedelta(days=1)).isoformat()
          end  =(dt.date.fromisoformat(friday)+dt.timedelta(days=7)).isoformat()
          cal=requests.get(f"{base}/v2/calendar",params={"start":start,"end":end},headers=H,timeout=20).json()
          first=(cal[0]["date"] if cal else None)
          today=dt.datetime.now(dt.timezone.utc).astimezone(ZoneInfo("America/New_York")).date().isoformat()
          do="1" if first and today==first else "0"
          open(os.environ["GITHUB_OUTPUT"],"a").write(f"do={do}\n")
          print("first:",first,"today:",today,"BUY=",do)

      - name: Prepare buy list (Top-K) — skip names already held / ordered
        id: buylist
        if: ${{ steps.gate.outputs.go == '1' && steps.buygate.outputs.do == '1' }}
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper
          TOPK:          ${{ env.TOPK || '6' }}
        shell: python
        run: |
          import os, requests, pandas as pd, pathlib as p

          pick = p.Path("backtests/picklist_highrsi_trend.csv")
          df = pd.read_csv(pick)
          wkcol = "week_start" if "week_start" in df.columns else ("week" if "week" in df.columns else None)
          week = str(pd.to_datetime(df[wkcol], errors="coerce").dropna().dt.date.max())
          if "rank" in df.columns:
              df = df.sort_values(["rank","symbol"], ascending=[True,True])
          elif "score" in df.columns:
              df = df.sort_values(["score","symbol"], ascending=[False,True])
          topk = int(os.getenv("TOPK","6"))
          picks = (df[pd.to_datetime(df[wkcol], errors="coerce").dt.date.astype(str)==week]["symbol"]
                      .dropna().astype(str).head(topk).tolist())

          base = "https://paper-api.alpaca.markets" if os.getenv("ALPACA_ENV","paper").startswith("paper") else "https://api.alpaca.markets"
          H = {"APCA-API-KEY-ID": os.environ["ALPACA_KEY"], "APCA-API-SECRET-KEY": os.environ["ALPACA_SECRET"]}

          # held positions
          held=set()
          r=requests.get(f"{base}/v2/positions", headers=H, timeout=15)
          if r.status_code==200:
              for pos in (r.json() or []):
                  q=float(pos.get("qty") or 0)
                  if abs(q)>0: held.add((pos.get("symbol") or "").upper())

          # open buy orders
          buying=set()
          r=requests.get(f"{base}/v2/orders", params={"status":"open","limit":500}, headers=H, timeout=15)
          if r.status_code==200:
              for od in (r.json() or []):
                  if (od.get("side")=="buy") and od.get("symbol"):
                      buying.add(od["symbol"].upper())

          filtered=[s for s in picks if s not in held and s not in buying]

          p.Path("backtests").mkdir(exist_ok=True)
          open("backtests/buy_symbols.txt","w").write("\n".join(filtered))

          any_buy = "1" if filtered else "0"
          print("TopK:", picks)
          print("Held:", sorted(held))
          print("Open buys:", sorted(buying))
          print("Filtered to:", filtered)
          open(os.environ["GITHUB_OUTPUT"],"a").write(f"any={any_buy}\n")


      - name: Preflight Top-K before buying (why/why-not)
        if: ${{ steps.gate.outputs.go == '1' && steps.buygate.outputs.do == '1' }}
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper
          NOTIONAL_PER:  "5000"
          TOPK:          ${{ env.TOPK || '6' }}
        shell: python
        run: |
          import os, sys, json, glob, pathlib, requests, pandas as pd
          data_dir = "stock_data_400"
          pick = pathlib.Path("backtests/picklist_highrsi_trend.csv")
          if not pick.exists():
              print("ERROR: picklist missing:", pick); sys.exit(78)

          df = pd.read_csv(pick)
          wkcol = "week_start" if "week_start" in df.columns else ("week" if "week" in df.columns else None)
          if not wkcol:
              print("ERROR: no week column in picklist"); sys.exit(1)

          week = os.environ.get("WEEK")
          if not week:
              week = str(pd.to_datetime(df[wkcol], errors="coerce").dropna().dt.date.max())
          print("Chosen WEEK:", week)

          k = int(os.getenv("TOPK", "6"))
          sel = df[pd.to_datetime(df[wkcol], errors="coerce").dt.date.astype(str) == week].copy()
          if "rank" in sel.columns: sel = sel.sort_values(["rank","symbol"], ascending=[True,True])
          elif "score" in sel.columns: sel = sel.sort_values(["score","symbol"], ascending=[False,True])
          picks = sel["symbol"].dropna().astype(str).head(k).tolist()
          print("Top-K:", picks)
          if not picks:
              print("No picks for WEEK → nothing to buy."); sys.exit(0)

          base = "https://paper-api.alpaca.markets" if os.getenv("ALPACA_ENV","paper").startswith("paper") else "https://api.alpaca.markets"
          H = {"APCA-API-KEY-ID": os.environ["ALPACA_KEY"], "APCA-API-SECRET-KEY": os.environ["ALPACA_SECRET"]}
          r = requests.get(f"{base}/v2/clock", headers=H, timeout=20)
          is_open = (r.status_code == 200 and (r.json() or {}).get("is_open", False))
          print("Alpaca clock is_open:", is_open)

          def last_close(sym):
              for p in sorted(glob.glob(f"{data_dir}/{sym}*.csv")):
                  try:
                      d = pd.read_csv(p, usecols=[0,4])  # Date, Close
                      if len(d): return float(d.iloc[-1,1])
                  except Exception:
                      pass
              return None

          notional = float(os.getenv("NOTIONAL_PER","0") or 0)
          print(f"Notional per name: {notional:,.2f} USD")

          for s in picks:
              a = requests.get(f"{base}/v2/assets/{s}", headers=H, timeout=20)
              tradable, frac = False, False
              if a.status_code == 200:
                  aj = a.json() or {}
                  tradable = bool(aj.get("tradable", False))
                  frac     = bool(aj.get("fractionable", False))
              lc = last_close(s)
              reasons = []
              if not tradable: reasons.append("NOT_TRADABLE")
              if not frac and lc is not None and notional < lc: reasons.append(f"NOT_FRACTIONABLE & notional<{lc:.2f}")
              if lc is None: reasons.append("NO_LOCAL_EOD")
              if reasons:
                  print(f"- {s}: SKIP → {', '.join(reasons)}")
              else:
                  print(f"- {s}: OK (tradable={tradable}, fractionable={frac}, last_close={lc})")

          if not is_open:
              print("NOTE: Market is closed; Alpaca will reject DAY market orders. We’ve gated earlier, but FYI.")

      - name: Derive WEEK from picklist (export)
        shell: python
        run: |
          import os, pandas as pd
          p = 'backtests/picklist_highrsi_trend.csv'
          df = pd.read_csv(p)
          wk = 'week_start' if 'week_start' in df.columns else ('week' if 'week' in df.columns else None)
          if not wk:
            raise SystemExit("No week column (week_start/week) in picklist.")
          week = str(pd.to_datetime(df[wk], errors='coerce').dropna().dt.date.max())
          print("WEEK =", week)
          open(os.environ['GITHUB_ENV'], 'a').write(f'WEEK={week}\n')

      - name: Buy once (long-only)
        if: ${{ steps.gate.outputs.go == '1' && steps.buygate.outputs.do == '1' && steps.buylist.outputs.any == '1' }}
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    paper
          NOTIONAL_PER:  "5000"
          TOPK:          ${{ env.TOPK || '6' }}
        shell: bash
        run: |
          set -e
          echo "NOTIONAL_PER=$NOTIONAL_PER"
          echo "WEEK=$WEEK  TOPK=${TOPK}"

          # Gate to open (so DAY orders don’t get rejected)
          python - <<'PY'
          import os, sys, time, requests, datetime as dt
          base = "https://paper-api.alpaca.markets" if os.getenv("ALPACA_ENV","paper").startswith("paper") else "https://api.alpaca.markets"
          h = {"APCA-API-KEY-ID": os.environ["ALPACA_KEY"], "APCA-API-SECRET-KEY": os.environ["ALPACA_SECRET"]}
          r = requests.get(f"{base}/v2/clock", headers=h, timeout=20)
          c = r.json() if r.status_code==200 else {}
          if c.get("is_open"): sys.exit(0)
          nxt = c.get("next_open")
          if not nxt: sys.exit(0)
          t = dt.datetime.fromisoformat(nxt.replace("Z","+00:00"))
          now = dt.datetime.now(dt.timezone.utc)
          wait = (t-now).total_seconds()
          if 0 < wait <= 7200:
              print(f"Market closed; sleeping {int(wait)}s until open...")
              time.sleep(int(wait))
          PY

          # ✅ Buy from the filtered list we built earlier
          python execute_orders.py \
            --broker alpaca \
            --data-dir stock_data_400 \
            --symbols-file backtests/buy_symbols.txt \
            --side buy \
            --notional "${NOTIONAL_PER}" \
            --init-stop-atr-mult 1.75

      - name: Show Alpaca positions (paper)
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
        run: python tools/moc_flatten.py

      # Mark as opened so this week won't buy again
      - name: Mark opened
        run: mkdir -p .open-flag && date > .open-flag/ok
