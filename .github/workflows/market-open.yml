name: IW Bot — Market Open

on:
  schedule:
    # Keep Mon–Fri so a Monday market holiday still buys on Tuesday
    - cron: "25 12 * * 1-5"   # pre-open window during EST
    - cron: "25 13 * * 1-5"   # pre-open window during EDT
  workflow_dispatch:
    inputs:
      force_buy:
        description: "Force weekly buy now (bypass first-session gate + dup guard)"
        type: boolean
        default: false
      topk:
        description: "Top-K weekly buys (default 6)"
        required: false
        default: "6"

concurrency:
  group: iwbot-open
  cancel-in-progress: false

jobs:
  open:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read

    env:
      TOPK: ${{ github.event.inputs.topk || '6' }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy requests

      # --- Compute last Friday (NY) ---
      - name: When (NY)
        id: when
        shell: python
        run: |
          from datetime import datetime, timedelta
          from zoneinfo import ZoneInfo
          import os

          ny = ZoneInfo("America/New_York")
          now = datetime.now(ny)
          d = now.date()
          while d.weekday() != 4:
              d -= timedelta(days=1)

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"friday={d}\n")

          print("Anchor Friday:", d)

      # --- Duplicate-buy guard per week (keyed by Friday date) ---
      - name: Dup guard for this Friday
        id: opened
        uses: actions/cache@v4
        with:
          path: .open-flag
          key: opened-${{ steps.when.outputs.friday }}

      - name: Exit if already opened this week
        if: steps.opened.outputs.cache-hit == 'true' && github.event.inputs.force_buy != 'true'
        run: echo "Already opened for ${{ steps.when.outputs.friday }}; exiting." && exit 0

      # --- Download weekly picks artifact (latest successful Friday Build) ---
      - name: Download weekly picks artifact (latest)
        uses: dawidd6/action-download-artifact@v2
        with:
          repo: ${{ github.repository }}
          workflow: friday-build.yml
          branch: main
          workflow_conclusion: success
          search_artifacts: true
          name_is_regexp: true
          name: ^weekly-picks-.*$
          path: backtests
          if_no_artifact_found: fail

      # --- Normalize picklist path (artifact may be nested) ---
      - name: Normalize picklist path
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar nullglob
          cand=(backtests/**/picklist_highrsi_trend.csv backtests/picklist_highrsi_trend.csv)
          for f in "${cand[@]}"; do
            if [[ -f "$f" ]]; then
              cp -f "$f" backtests/picklist_highrsi_trend.csv
              echo "Picklist copied from $f"
              exit 0
            fi
          done
          echo "ERROR: picklist_highrsi_trend.csv not found in downloaded artifacts"
          echo "Found files:"
          find backtests -maxdepth 3 -type f -print || true
          exit 1

      - name: Derive WEEK from picklist (export)
        shell: python
        run: |
          import os, pandas as pd
          p = "backtests/picklist_highrsi_trend.csv"
          df = pd.read_csv(p)
          wk = "week_start" if "week_start" in df.columns else ("week" if "week" in df.columns else None)
          if not wk:
              raise SystemExit("No week column (week_start/week) in picklist.")
          week = str(pd.to_datetime(df[wk], errors="coerce").dropna().dt.date.max())
          print("WEEK =", week)
          open(os.environ["GITHUB_ENV"], "a").write(f"WEEK={week}\n")

      - name: Sanity — show backtests/
        run: ls -Rlh backtests || true

      # --- Gate to US open (sleep ≤2h unless forced) ---
      - name: Gate to U.S. open (sleep ≤2h)
        id: gate
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    live
          FORCE_BUY:     ${{ github.event.inputs.force_buy }}
        shell: python
        run: |
          import os, time, sys, requests, datetime as dt

          if str(os.getenv("FORCE_BUY","false")).lower()=="true":
              open(os.environ["GITHUB_OUTPUT"],"a").write("go=1\n")
              print("FORCE_BUY=true → go=1 (bypass clock wait)")
              sys.exit(0)

          base = "https://paper-api.alpaca.markets" if os.getenv("ALPACA_ENV","paper").startswith("paper") else "https://api.alpaca.markets"
          H = {"APCA-API-KEY-ID": os.environ["ALPACA_KEY"], "APCA-API-SECRET-KEY": os.environ["ALPACA_SECRET"]}

          c = requests.get(f"{base}/v2/clock", headers=H, timeout=20).json()
          if c.get("is_open"):
              open(os.environ["GITHUB_OUTPUT"],"a").write("go=1\n")
              print("Market already open → go=1")
              sys.exit(0)

          t = dt.datetime.fromisoformat(c["next_open"].replace("Z","+00:00"))
          sec = max(0, (t - dt.datetime.now(dt.timezone.utc)).total_seconds())

          if sec > 7200:
              open(os.environ["GITHUB_OUTPUT"],"a").write("go=0\n")
              print("Next open is >2h away → go=0")
              sys.exit(0)

          print(f"Sleeping {int(sec)+3}s until open…")
          time.sleep(int(sec)+3)
          open(os.environ["GITHUB_OUTPUT"],"a").write("go=1\n")

      # --- Decide if first session after Friday (unless forced) ---
      - name: Decide if first session after Friday
        id: buygate
        if: ${{ steps.gate.outputs.go == '1' }}
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    live
          FORCE_BUY:     ${{ github.event.inputs.force_buy }}
        shell: python
        run: |
          import os, requests, datetime as dt
          from zoneinfo import ZoneInfo

          if str(os.getenv("FORCE_BUY","false")).lower()=="true":
              open(os.environ["GITHUB_OUTPUT"],"a").write("do=1\n")
              print("force_buy=true → buygate.do=1")
              raise SystemExit(0)

          base = "https://paper-api.alpaca.markets" if os.getenv("ALPACA_ENV","paper").startswith("paper") else "https://api.alpaca.markets"
          H = {"APCA-API-KEY-ID": os.environ["ALPACA_KEY"], "APCA-API-SECRET-KEY": os.environ["ALPACA_SECRET"]}

          friday = "${{ steps.when.outputs.friday }}"
          start  = (dt.date.fromisoformat(friday) + dt.timedelta(days=1)).isoformat()
          end    = (dt.date.fromisoformat(friday) + dt.timedelta(days=7)).isoformat()

          cal = requests.get(f"{base}/v2/calendar", params={"start": start, "end": end}, headers=H, timeout=20).json()
          first = (cal[0]["date"] if cal else None)

          today = dt.datetime.now(dt.timezone.utc).astimezone(ZoneInfo("America/New_York")).date().isoformat()
          do = "1" if first and today == first else "0"

          open(os.environ["GITHUB_OUTPUT"],"a").write(f"do={do}\n")
          print("first:", first, "today:", today, "BUY=", do)

      # --- Prepare buy list (Top-K), skip names already held/ordered ---
      - name: Prepare buy list (Top-K) — skip names already held / ordered
        id: buylist
        if: ${{ steps.gate.outputs.go == '1' && steps.buygate.outputs.do == '1' }}
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    live
          TOPK:          ${{ env.TOPK }}
        shell: python
        run: |
          import os, requests, pandas as pd
          from pathlib import Path

          pick = Path("backtests/picklist_highrsi_trend.csv")
          df = pd.read_csv(pick)

          wkcol = "week_start" if "week_start" in df.columns else ("week" if "week" in df.columns else None)
          week = str(pd.to_datetime(df[wkcol], errors="coerce").dropna().dt.date.max())

          if "rank" in df.columns:
              df = df.sort_values(["rank","symbol"], ascending=[True,True])
          elif "score" in df.columns:
              df = df.sort_values(["score","symbol"], ascending=[False,True])

          topk = int(os.getenv("TOPK","6"))
          picks = (df[pd.to_datetime(df[wkcol], errors="coerce").dt.date.astype(str) == week]["symbol"]
                    .dropna().astype(str).head(topk).tolist())

          base = "https://paper-api.alpaca.markets" if os.getenv("ALPACA_ENV","paper").startswith("paper") else "https://api.alpaca.markets"
          H = {"APCA-API-KEY-ID": os.environ["ALPACA_KEY"], "APCA-API-SECRET-KEY": os.environ["ALPACA_SECRET"]}

          # held positions
          held = set()
          r = requests.get(f"{base}/v2/positions", headers=H, timeout=20)
          if r.status_code == 200:
              for pos in (r.json() or []):
                  q = float(pos.get("qty") or 0)
                  if abs(q) > 0:
                      held.add((pos.get("symbol") or "").upper())

          # open buy orders
          buying = set()
          r = requests.get(f"{base}/v2/orders", params={"status":"open","limit":500}, headers=H, timeout=20)
          if r.status_code == 200:
              for od in (r.json() or []):
                  if od.get("side") == "buy" and od.get("symbol"):
                      buying.add(od["symbol"].upper())

          filtered = [s for s in picks if s.upper() not in held and s.upper() not in buying]

          Path("backtests").mkdir(exist_ok=True)
          Path("backtests/buy_symbols.txt").write_text("\n".join(filtered), encoding="utf-8")

          any_buy = "1" if filtered else "0"
          print("WEEK:", week)
          print("TopK:", picks)
          print("Held:", sorted(held))
          print("Open buys:", sorted(buying))
          print("Filtered:", filtered)

          open(os.environ["GITHUB_OUTPUT"],"a").write(f"any={any_buy}\n")

      # --- Place weekly buys (API-only) ---
      - name: Buy once (weekly allow-list, safe notional)
        if: ${{ steps.gate.outputs.go == '1' && steps.buygate.outputs.do == '1' && steps.buylist.outputs.any == '1' }}
        env:
          ALPACA_KEY:    ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENV:    live
          NOTIONAL_PER:  "5000"
        run: python tools/place_weekly_buys.py

      # --- Upload model allow-list and report (if present) ---
      - name: Upload model allow-list (symbols opened by model)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: model-allowlist-${{ steps.when.outputs.friday }}
          path: |
            backtests/model_symbols.txt
            backtests/buy_exec_report.csv
          if-no-files-found: warn

      # Mark as opened so this week won't buy again (unless force_buy)
      - name: Mark opened
        if: ${{ steps.gate.outputs.go == '1' && steps.buygate.outputs.do == '1' && steps.buylist.outputs.any == '1' }}
        run: mkdir -p .open-flag && date > .open-flag/ok
